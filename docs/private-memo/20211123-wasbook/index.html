<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』個人メモ - グリのクソブログ</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』個人メモ" />
<meta property="og:description" content="セキュリティなんも知らんので購入。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://guricerin.github.io/shit-blog/private-memo/20211123-wasbook/" />
<meta property="article:published_time" content="2021-11-23T18:53:50+09:00" />
<meta property="article:modified_time" content="2021-11-23T18:53:50+09:00" />

		<meta itemprop="name" content="『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』個人メモ">
<meta itemprop="description" content="セキュリティなんも知らんので購入。">
<meta itemprop="datePublished" content="2021-11-23T18:53:50&#43;09:00" />
<meta itemprop="dateModified" content="2021-11-23T18:53:50&#43;09:00" />
<meta itemprop="wordCount" content="2123">



<meta itemprop="keywords" content="" />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』個人メモ"/>
<meta name="twitter:description" content="セキュリティなんも知らんので購入。"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/style.css">
	<link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/custom.css">

	<link rel="shortcut icon" href="https://guricerin.github.io/shit-blog/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109224463-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="https://guricerin.github.io/shit-blog/" title="グリのクソブログ" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="https://guricerin.github.io/shit-blog/img/icon.jpg">
				</div><div class="logo__item logo__text">
					<div class="logo__title">グリのクソブログ</div>
					<div class="logo__tagline">主にB&#39;z</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/">
				
				<span class="menu__text">HOME</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/privacy-policy">
				
				<span class="menu__text">PRIVACY POLICY</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/feed.xml">
				
				<span class="menu__text">RSS</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』個人メモ</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2021-11-23T18:53:50&#43;09:00">2021-11-23</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="https://guricerin.github.io/shit-blog/categories/%E6%9B%B8%E7%89%A9/" rel="category">書物</a>, <a class="meta__link" href="https://guricerin.github.io/shit-blog/categories/%E6%83%85%E5%A0%B1%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/" rel="category">情報セキュリティ</a>
	</span>
</div></div>
		</header>
		
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#環境">環境</a></li>
    <li><a href="#3章-webセキュリティの基礎">3章 Webセキュリティの基礎</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#4章-webアプリケーションの機能別に見るセキュリティバグ">4章 Webアプリケーションの機能別に見るセキュリティバグ</a>
      <ul>
        <li></li>
        <li><a href="#入力処理とセキュリティ">入力処理とセキュリティ</a></li>
        <li><a href="#表示処理に伴う問題">表示処理に伴う問題</a></li>
        <li><a href="#sql呼び出しに伴う脆弱性">SQL呼び出しに伴う脆弱性</a></li>
        <li><a href="#重要な処理の際に混入する脆弱性">「重要な処理」の際に混入する脆弱性</a></li>
        <li><a href="#セッション管理の不備">セッション管理の不備</a></li>
        <li><a href="#リダイレクト処理にまつわる脆弱性">リダイレクト処理にまつわる脆弱性</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
        <li><a href="#クッキー出力にまつわる脆弱性">クッキー出力にまつわる脆弱性</a></li>
        <li><a href="#メール送信の問題">メール送信の問題</a></li>
        <li><a href="#ファイルアクセスにまつわる問題">ファイルアクセスにまつわる問題</a></li>
        <li><a href="#osコマンド呼び出しの際に発生する脆弱性">OSコマンド呼び出しの際に発生する脆弱性</a></li>
        <li><a href="#ファイルアップロードにまつわる問題">ファイルアップロードにまつわる問題</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#インクルードにまつわる問題">インクルードにまつわる問題</a></li>
        <li><a href="#構造化データの読み込みにまつわる問題">構造化データの読み込みにまつわる問題</a></li>
        <li><a href="#共有資源やキャッシュに関する問題">共有資源やキャッシュに関する問題</a></li>
        <li><a href="#web-api実装における脆弱性">Web API実装における脆弱性</a></li>
        <li><a href="#javascriptの問題">JavaScriptの問題</a></li>
      </ul>
    </li>
    <li><a href="#5章-代表的なセキュリティ機能">5章 代表的なセキュリティ機能</a>
      <ul>
        <li><a href="#認証">認証</a></li>
        <li><a href="#アカウント管理">アカウント管理</a></li>
        <li><a href="#認可">認可</a></li>
        <li><a href="#ログ出力">ログ出力</a></li>
      </ul>
    </li>
    <li><a href="#6章-文字コードとセキュリティ">6章 文字コードとセキュリティ</a>
      <ul>
        <li><a href="#脆弱性">脆弱性</a></li>
        <li><a href="#対策-15">対策</a></li>
      </ul>
    </li>
    <li><a href="#7章-脆弱性診断入門">7章 脆弱性診断入門</a></li>
    <li><a href="#8章-webサイトの安全性を高めるために">8章 Webサイトの安全性を高めるために</a>
      <ul>
        <li><a href="#webサーバへの攻撃経路と対策">Webサーバへの攻撃経路と対策</a></li>
        <li><a href="#成りすまし対策">成りすまし対策</a></li>
        <li><a href="#盗聴改竄対策">盗聴・改竄対策</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			<p>セキュリティなんも知らんので購入。</p>
<p>サポートサイト : <a href="https://wasbook.org/">https://wasbook.org/</a></p>
<p>Webアプリに対する代表的なセキュリティ攻撃とその対策を網羅する書籍。攻撃と防御の実演には、ローカルネットワークで繋げた仮想環境を用いる。</p>
<hr>
<h2 id="環境">環境</h2>
<ul>
<li>Windows 11 Pro
<ul>
<li>バージョン : 21H2</li>
<li>ビルド : 22000.318</li>
<li>CPU : AMD Ryzen 7 3700X 8-Core Processor</li>
<li>Hyper-V : 有効にしたまま</li>
</ul>
</li>
<li>VirtualBox : バージョン 6.1.30 r148432 (Qt5.6.2)</li>
<li>OWASP ZAP : バージョン 2.11</li>
<li>JRE : バージョン 1.8.0_311</li>
<li>FireFox : バージョン 94.0.2</li>
</ul>
<hr>
<h2 id="3章-webセキュリティの基礎">3章 Webセキュリティの基礎</h2>
<h4 id="パーセントエンコーディング">パーセントエンコーディング</h4>
<ul>
<li>URL上で特別な意味をもつ記号やUTF-8文字などをURL上に記載する場合に使う。</li>
<li><code>%</code>で区切って符号化する。</li>
</ul>
<h4 id="referer">Referer</h4>
<ul>
<li>リンク元のURLを示すヘッダ。</li>
<li>セキュリティの役に立つ場合もあれば、問題の原因になる場合もある。
<ul>
<li>URLが秘密情報を含む場合は問題。</li>
</ul>
</li>
<li>プロキシやブラウザのプラグイン、セキュリティソフトに改変される場合があるので、正しいリンク元を示しているとは限らない。</li>
</ul>
<h4 id="秘密情報はpostで送信すべき">秘密情報はPOSTで送信すべき</h4>
<ul>
<li>URL上のパラメータがReferer経由で外部に漏洩する。</li>
<li>URL上のパラメータがアクセスログに残る。</li>
<li>URL上のパラメータがブラウザのアドレスバーに表示され他人に覗かれる。</li>
<li>パラメータつきのURLを他人がSNSなどに共有してしまう。</li>
</ul>
<h4 id="hidden">hidden</h4>
<ul>
<li>hiddenパラメータを処理する部分に脆弱性がある場合、プロキシによって改変可能。</li>
<li>利用者自身からは改変できるが、情報漏えいや第三者からの改変に対しては堅牢。</li>
</ul>
<h4 id="認証authentication">認証（Authentication）</h4>
<ul>
<li>利用者が確かに本人であることをなんらかの手段で確認すること。</li>
<li>HTTP認証
<ul>
<li>ブラウザ側でIDやパスワードを記憶する。</li>
</ul>
</li>
</ul>
<h4 id="認可authorization">認可（Authorization）</h4>
<ul>
<li>認証済みの利用者に権限を与えること。</li>
<li>たいていのWebアプリは認証したユーザをすぐ認可するのでこれらをごっちゃにしやすいが、厳密に区別せよ。</li>
</ul>
<h4 id="クッキーcookie">クッキー（cookie）</h4>
<ul>
<li>サーバ側からブラウザに対して「変数=値」の組を覚えておくように指示するもの。</li>
<li>セッション管理の実現に使用される。</li>
<li>クッキーが保持できる値の個数や文字列長には制限がある。</li>
<li>ユーザ本人から参照・変更可能なので、秘密情報の格納には向かない。
<ul>
<li>「整理番号」としてのセッションIDを格納し、秘密情報はサーバ側で管理する。</li>
</ul>
</li>
</ul>
<h4 id="セッションidに求められる要件">セッションIDに求められる要件</h4>
<ul>
<li>第三者が推測できないこと。
<ul>
<li>十分な桁数の乱数。</li>
<li>セッション管理機構は自作しない。開発ツールでセッションIDを生成せよ。</li>
</ul>
</li>
<li>第三者からセッションIDを強制されないこと。
<ul>
<li>セッションID固定化攻撃（Session Fixation Attack）</li>
<li>認証後に新規のセッションIDを発行することで防止可能。</li>
</ul>
</li>
<li>第三者が漏洩しないこと。
<ul>
<li>クッキー発行の際の属性に不備。</li>
<li>ネットワーク的にセッションIDが盗聴される。</li>
<li>XSSなどアプリの脆弱性によって漏洩。</li>
<li>PHPやブラウザなどプラットフォームの脆弱性により漏洩。</li>
<li>セッションIDをURLに保持している場合はRefererヘッダから漏洩。</li>
</ul>
</li>
</ul>
<h4 id="セキュリティ上で重要なクッキー属性">セキュリティ上で重要なクッキー属性</h4>
<ul>
<li>Domain
<ul>
<li>デフォルトでは、クッキーはクッキーを発行したサーバにのみ送信される。これが最も安全。</li>
<li>設定すると、同じドメインの別サーバにもクッキーが送信される。</li>
<li>原則として設定してはいけない。</li>
</ul>
</li>
<li>Secure
<ul>
<li>HTTPS通信の場合のみサーバに送信される。</li>
<li>この属性がないクッキーはHTTPS通信じゃなくても送信される。</li>
</ul>
</li>
<li>HttpOnly
<ul>
<li>この属性が付与されたクッキーはJavaScriptからアクセスできなくなる。</li>
</ul>
</li>
<li>SameSite
<ul>
<li>Strict, Lax, Noneのいずれか。</li>
<li>Laxを指定されたクッキーは、他サイトからPOSTメソッドなどで遷移した場合は送信されなくなる。
<ul>
<li>CSRF脆弱性のある程度の緩和になる。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="能動的攻撃active-attack">能動的攻撃（active attack）</h4>
<ul>
<li>攻撃者がWebサーバに直接攻撃する。</li>
<li>ex. SQLインジェクション</li>
</ul>
<h4 id="受動的攻撃passie-attack">受動的攻撃（passie attack）</h4>
<ul>
<li>Webサイトのユーザに罠を仕掛け、そのユーザを通してサーバを攻撃する。</li>
<li>パターン
<ul>
<li>罠サイトに誘導し、マルウェアに感染させる。</li>
<li>正規サイトに罠を仕掛け、マルウェアに感染させる。
<ul>
<li>FTPなどのパスワードを不正入手し、コンテンツを書き換える。</li>
<li>Webサーバの脆弱性をついてコンテンツを書き換える。</li>
<li>SQLインジェクションによってコンテンツを書き換える。</li>
<li>SNSなどユーザが投稿できるサイトのXSS脆弱性を悪用する。</li>
</ul>
</li>
<li>罠サイトと正規サイトをまたがった攻撃。
<ul>
<li>正規サイトにログインしているユーザのアカウントを悪用。</li>
<li>CSRF, XSS, HTTPヘッダ・インジェクション</li>
</ul>
</li>
</ul>
</li>
<li>ブラウザ側の防衛策
<ul>
<li>ユーザに配布元を確認させ、ユーザが許可した場合のみ実行。</li>
<li>サンドボックス
<ul>
<li>プログラムのできることを制限。</li>
<li>ローカルファイルへのアクセス禁止。</li>
<li>プリンタなどの資源の利用禁止（画面表示は可能）。</li>
<li>ネットワークアクセスの制限（同一オリジンポリシー）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="同一オリジンポリシーsame-origin-policy">同一オリジンポリシー（same origin policy）</h4>
<ul>
<li>JavaScriptなどのクライアントスクリプトからサイトをまたがったアクセスを禁止する制限。
<ul>
<li>ex. iframeによる他サイトのコンテンツ取得を禁止する。</li>
</ul>
</li>
<li>オリジン : データの送信元。</li>
<li>同一オリジンである条件
<ul>
<li>URLのホストが一致。</li>
<li>スキーム（プロトコル）が一致。</li>
<li>ポート番号が一致。</li>
</ul>
</li>
</ul>
<h4 id="javascript以外のブラウザ機能でクロスドメインのアクセスが許可されているもの">javaScript以外のブラウザ機能でクロスドメインのアクセスが許可されているもの</h4>
<ul>
<li>frame要素、iframe要素</li>
<li>img要素</li>
<li>script要素
<ul>
<li>src属性を指定すると他サイトからJSをロード可能。</li>
</ul>
</li>
<li>CSS
<ul>
<li>IEにはCSSXSSという脆弱性が存在した。</li>
<li>最新のブラウザなら大丈夫。</li>
</ul>
</li>
<li>form要素のaction属性
<ul>
<li>submitはJSから常に操作可能。</li>
<li>この仕様を悪用するのがCSRF攻撃。</li>
</ul>
</li>
</ul>
<h4 id="cors-cross-origin-resource-sharing">CORS (Cross-Origin Resource Sharing)</h4>
<ul>
<li>Webサーバ側でCORSの指定を行うと、同一オリジンポリシーの制限を緩和して指定されたオリジン（のコンテンツ）へのアクセスが可能となる。</li>
<li>同一オリジンポリシーと互換性を持ちつつ、安全性を保ってクロスオリジンアクセスを実現した仕様。</li>
</ul>
<h4 id="シンプルなリクエスト">シンプルなリクエスト</h4>
<ul>
<li>以下の条件を満たす場合、XMLHttpRequestなどを用いて異なるオリジンにHTTPリクエストを送信することが、相手側の許可なしに可能。
<ul>
<li>メソッドはGET, HEAD, POSTのいずれか</li>
<li>XMLHttpRequestオブジェクトの<code>setRequestHeader</code>メソッドで設定するリクエストヘッダは以下に限る。
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Content-Type</li>
</ul>
</li>
<li>Content-Typeヘッダは以下のいずれか
<ul>
<li>application/x-www-form-urlencoded</li>
<li>multipart/form-data</li>
<li>text/plain</li>
</ul>
</li>
</ul>
</li>
<li><code>Access-Control-Allow-Origin</code>
<ul>
<li>HTTPレスポンスヘッダ</li>
<li>指定したクロスオリジンからのコンテンツ読み出しを許可する。</li>
</ul>
</li>
</ul>
<h4 id="プリフライトリクエストpre-flight-request">プリフライトリクエスト（pre-flight request）</h4>
<ul>
<li>クロスオリジンアクセスにおいて、シンプルなリクエストにならない場合、ブラウザが送信するHTTPリクエスト。</li>
<li>HTTPメソッドは<code>OPTIONS</code></li>
</ul>
<h4 id="認証情報を含むリクエスト">認証情報を含むリクエスト</h4>
<ul>
<li>デフォルトでは、クロスオリジンに対するリクエストにはHTTP認証やクッキーなどの認証に用いられるリクエストヘッダは自動的に送信されない。</li>
<li>送信するには、XMLHttpRequestのプロパティ<code>withCredentials</code>をtrueにセットする。</li>
<li>サーバはそれに対して<code>Access-Control-Allow-Credentials: true</code>レスポンスヘッダを返す。</li>
</ul>
<hr>
<h2 id="4章-webアプリケーションの機能別に見るセキュリティバグ">4章 Webアプリケーションの機能別に見るセキュリティバグ</h2>
<h4 id="インジェクション系脆弱性">インジェクション系脆弱性</h4>
<ul>
<li>データの中に「データの終端」を示すマークを混入させ、その後の文字列の構造を変化させる攻撃に関する脆弱性。</li>
</ul>
<h3 id="入力処理とセキュリティ">入力処理とセキュリティ</h3>
<ul>
<li>Webアプリにおける入力 : HTTPリクエストとして渡されるパラメータ。</li>
<li>入力処理
<ul>
<li>文字エンコーディングの妥当性検証</li>
<li>（必要な場合のみ）文字エンコーディングの変換
<ul>
<li>HTTPメッセージとプログラム内部で文字エンコーディングが異なる場合。</li>
</ul>
</li>
<li>入力値（パラメータ文字列）の妥当性検証
<ul>
<li>入力値の間違いを早期に発見して再入力を促し、ユーザビリティ（使いやすさ）が向上する。</li>
<li>データの不整合を防ぎ、システムの信頼性を向上させる。</li>
<li>「すべての文字を許容する」場合などもあるので、あくまで保険的な対策止まり。</li>
<li>hiddenパラメータ、ラジオボタン、select要素、クッキーの値など、すべてのパラメータを検証すべき。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="バイナリセーフ">バイナリセーフ</h4>
<ul>
<li>入力値がどんなバイト列でも正しく扱えること。</li>
<li>PHPの典型では、値0のヌルバイト（<code>\0</code>）が現れても正しく処理できること。</li>
<li>バイナリセーフでない関数などでは、ヌルバイト攻撃される。</li>
</ul>
<h4 id="ヌルバイト攻撃">ヌルバイト攻撃</h4>
<ul>
<li>ヌルバイトを文字列終端としてそれ以降を切り詰める特性を利用する攻撃。</li>
<li>XSS, ディレクトリトラバーサルと組み合わされることが多い。</li>
<li>ex. URLのクエリパラメータとして、「<code>%00</code> + JSスクリプト」を仕込む。</li>
</ul>
<h4 id="その他の入力値検証">その他の入力値検証</h4>
<ul>
<li>制御文字のチェック
<ul>
<li>意外と忘れがち。</li>
<li>文字種が指定されていない場合も制御文字は弾くべき。</li>
<li>textarea要素などの場合は改行・タブは許容しても、それ以外の制御文字はやはり弾くべき。</li>
</ul>
</li>
<li>文字数のチェック
<ul>
<li>すべてのパラメータについて最大文字数を仕様に定義するべき。</li>
<li>インジェクション脆弱性があっても攻撃には至らない。</li>
</ul>
</li>
<li>数値の最小値・最大値チェック
<ul>
<li>数値文字列としての文字種・文字数のチェック</li>
<li>文字列型から数値型への型変換</li>
<li>最小値・最大値の範囲であることの確認</li>
</ul>
</li>
</ul>
<h4 id="正規表現">正規表現</h4>
<ul>
<li><code>\A</code>と<code>\z</code>はデータの先頭と末尾にマッチ。</li>
<li><code>^</code>と<code>$</code>は行の先頭と末尾にマッチ。
<ul>
<li><code>$</code>は改行にマッチするので、これらをデータの先頭・末尾として使うと改行文字をすり抜ける。</li>
</ul>
</li>
<li>全体一致検索を行う関数がある場合は、<code>\A</code>と<code>\z</code>で囲む必要なし。</li>
</ul>
<h3 id="表示処理に伴う問題">表示処理に伴う問題</h3>
<h4 id="クロスサイトスクリプティングxss-cross-site-scripting">クロスサイト・スクリプティング（XSS, Cross-Site Scripting）</h4>
<ul>
<li>影響
<ul>
<li>サイトユーザのブラウザ上で、攻撃者の用意したスクリプトの実行により
<ul>
<li>クッキー値を盗まれ、ユーザがなりすまされる。</li>
<li>ユーザの権限でWebアプリの機能を悪用される。</li>
</ul>
</li>
<li>Webサイト上に偽の入力フォームが表示され、フィッシングによりユーザが個人情報を盗まれる。</li>
</ul>
</li>
<li>発生箇所
<ul>
<li>Webアプリ上でHTML, JSを生成している箇所。</li>
</ul>
</li>
<li>影響を受けるページ : Webアプリ全体</li>
<li>ユーザ関与
<ul>
<li>必要。</li>
<li>罠サイトの閲覧、メール記載のURLの起動、攻撃を受けたサイトの閲覧など。</li>
</ul>
</li>
<li>対策
<ul>
<li>HTMLで特別な意味を持つ記号文字（メタ文字）をエスケープする。</li>
<li>HTTPレスポンスに文字エンコーディングを明示する。</li>
</ul>
</li>
</ul>
<h5 id="クッキー値の盗み出し">クッキー値の盗み出し</h5>
<ul>
<li>認証機能のあるサイトにて</li>
<li>URLクエリパラメータにJSスクリプトを仕込む。
<ul>
<li>ex. ?keyword=<code>&amp;lt</code>;script<code>&amp;gt</code>;alert(document.cookie)<code>&amp;lt</code>;/script<code>&amp;gt</code>;</li>
</ul>
</li>
<li>脆弱性のあるサイトの正規ユーザを罠サイトに誘い、
<ul>
<li>罠サイトのiframe内で、脆弱なサイトを表示。
<ul>
<li>この際、iframeをCSSで隠す。</li>
</ul>
</li>
<li>脆弱なサイトはXSS攻撃により、クッキー値をクエリ文字列につけて、情報収集ページに遷移。</li>
<li>情報収集ページは受け取ったクッキー値を攻撃者にメールで報告。</li>
</ul>
</li>
</ul>
<h5 id="ajaxの流行">Ajaxの流行</h5>
<ul>
<li>JSからWebサイトの機能を呼び出すためのAPIが用意されることが増えた。</li>
<li>APIは攻撃に悪用可能なので、XSSとJSの組み合わせによる攻撃がしやすくなっている。</li>
</ul>
<h5 id="画面の置き換え">画面の置き換え</h5>
<ul>
<li>認証機能のないサイトにて
<ul>
<li>ユーザを罠サイトに誘導。</li>
<li>リンクに見せかけたボタンを押させる。</li>
<li>脆弱性のあるサイトにHTMLを仕込む。
<ul>
<li>悪意のあるformを、元のformより前面に位置づける。</li>
<li>背景色を白にし、元のformが透けて見えないようにする。</li>
<li>actionのurlには罠サイトを指定する。</li>
<li>ユーザが個人情報を入力してsubmitしたら、攻撃者に情報が送信される。</li>
</ul>
</li>
</ul>
</li>
<li>スキーマがhttpsの場合でも、証明書は正規のものになる。</li>
</ul>
<h5 id="反射型xssreflected-xss">反射型XSS（reflected XSS）</h5>
<ul>
<li>攻撃用JSが、攻撃対象サイトとは別のサイト（罠サイトやメールのURL）にある場合のXSS。</li>
<li>多くの場合、入力パラメータをそのまま表示する脆弱なページで発生。</li>
</ul>
<h5 id="持続型xssstored-xss-persistent-xss">持続型XSS（stored XSS, persistent XSS）</h5>
<ul>
<li>攻撃用JSが、攻撃対象のDBなどに保存される場合のXSS。</li>
<li>典型的なターゲットは、WebメールやSNS。</li>
<li>ユーザを罠サイトに誘導する手間がない。</li>
</ul>
<h5 id="xss脆弱性が生まれる原因">XSS脆弱性が生まれる原因</h5>
<ul>
<li>HTML生成の際に、HTMLのメタ文字を制御していないこと。</li>
<li>HTMLやJSを注入される。</li>
<li>要素内容のXSS
<ul>
<li>HTMLの要素内容（通常のテキスト領域）。</li>
<li><code>&lt;</code>と<code>&amp;</code>をエスケープできていない場合に、任意のHTMLを注入される。</li>
</ul>
</li>
<li>引用符で囲まない属性値のXSS
<ul>
<li>空白で属性値の終わりになるので、空白を挟んで任意の属性を追加される。</li>
<li>属性値を<code>&quot;</code>で囲むようにする。</li>
</ul>
</li>
<li>引用符で囲った属性値のXSS
<ul>
<li><code>&quot;</code>, <code>&lt;</code>, <code>&amp;</code>をエスケープできていなければ、任意の属性を追加される。</li>
</ul>
</li>
</ul>
<h5 id="xssに対する保険的対策">XSSに対する保険的対策</h5>
<ul>
<li>XSS脆弱性は対策が必要な箇所が非常に多く、HTMLの文脈によって異なる対策をとる必要があるので対策漏れが発生しやすい。</li>
<li>万一対策が漏れていた場合の保険
<ul>
<li><code>X-XSS-Protection</code>レスポンスヘッダの使用
<ul>
<li>ブラウザには反射型XSSを防ぐXSSフィルタが実装されている場合がある。</li>
<li>ユーザによるブラウザのXSSフィルタ設定を上書きして有効化する。</li>
<li>2020-01現在、XSSフィルタが有効なブラウザはSafariのみ。</li>
<li>すべてのHTTPレスポンスで雑に以下を出力することを推奨。
<ul>
<li><code>X-XSS-Protection: 1; mode-block</code></li>
<li>Webサーバ（Apache, nginxなど）の設定でこのヘッダを出力設定するのが楽。</li>
</ul>
</li>
</ul>
</li>
<li>入力値検証</li>
<li>クッキーに<code>HttpOnly</code>属性を付与する
<ul>
<li>JSからのクッキーの読み出しを禁止。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="href属性やsrc属性のxss">href属性やsrc属性のXSS</h5>
<ul>
<li>URLを属性値としてとる。</li>
<li>属性に<code>javascript:[JSスクリプト]</code>のように<code>javascript</code>スキームを仕込むことで、任意のJSスクリプトが実行される。</li>
<li>対策
<ul>
<li>URLを動的に生成する際、以下のみを許可するようチェック。
<ul>
<li>httpスキームとhttpsスキームで始まる絶対URL</li>
<li><code>/</code>で始まる相対URL</li>
</ul>
</li>
<li>リンク先ドメインをチェック。
<ul>
<li>リンク先URLを検証し、外部ドメインならエラー。</li>
<li>外部ドメインへのリンクであることをユーザに注意喚起するためのクッションページを表示。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="イベントハンドラのxss">イベントハンドラのXSS</h5>
<ul>
<li>JSの一部をサーバ側で動的生成する例
<ul>
<li>典型的には、JSの文字列リテラルの動的生成。</li>
</ul>
</li>
<li>JSの文字列リテラルのエスケープ漏れにより、任意のJSコードが実行される。</li>
<li>対策
<ol>
<li>データをJS文字列リテラルとしてエスケープ。</li>
<li>それをHTMLエスケープ。</li>
</ol>
</li>
</ul>
<h5 id="script要素のxss">script要素のXSS</h5>
<ul>
<li>script要素内はHTMLエスケープの必要はなく、JSの文字列リテラルとしてのエスケープを行う。が、それだけでは不十分。</li>
<li>パラメータに<code>&lt;/script&gt;</code>を仕込まれるとscript要素が勝手に終了させられ、任意のスクリプトを実行させられる。</li>
<li>JSのエスケープルールは複雑なので、JSを動的生成させるのは避けたほうが無難。</li>
</ul>
<h5 id="それでもjsを動的生成したい場合">それでもJSを動的生成したい場合</h5>
<ul>
<li>script要素の外部（HTML）でパラメータを定義し、JSから参照させる。
<ul>
<li>カスタムデータ属性（<code>data-</code>から始まる任意の属性名を設定可能）を利用する。</li>
<li>カスタムデータ属性は通常のHTMLエスケープでXSS対策可能。</li>
</ul>
</li>
<li>インラインJSONPを使う。
<ul>
<li>JSON形式のパラメータを伴う関数をscript要素内で呼び出す。</li>
</ul>
</li>
</ul>
<h5 id="htmlタグやcssの入力を許す場合の対策">HTMLタグやCSSの入力を許す場合の対策</h5>
<ul>
<li>ブログシステムやSNSでユーザカスタム機能などを開発する場合</li>
<li>HTMLテキストを構文解析して必要な要素のみを抽出するようなライブラリを使用する。</li>
</ul>
<h4 id="エラーメッセージからの情報漏洩">エラーメッセージからの情報漏洩</h4>
<ul>
<li>エラーメッセージに攻撃者にとって有益なアプリ内部情報が含まれる。
<ul>
<li>エラーを起こしている関数名、DBのテーブル名・列名など。</li>
</ul>
</li>
<li>意図的な攻撃として、エラーメッセージに秘密情報（個人情報など）を表示させられる。</li>
<li>対策
<ul>
<li>エラー発生時、画面表示するのはユーザ向けのメッセージに留める。</li>
<li>詳細内容はエラーログに出力する。</li>
</ul>
</li>
</ul>
<h3 id="sql呼び出しに伴う脆弱性">SQL呼び出しに伴う脆弱性</h3>
<h4 id="sqlインジェクション">SQLインジェクション</h4>
<ul>
<li>発生箇所 : SQL呼び出しをしている箇所。</li>
<li>影響を受けるページ : すべてのページ。</li>
<li>影響
<ul>
<li>DB内のすべての情報が外部から盗まれる。</li>
<li>DBの内容は書き換えられる。</li>
<li>認証を回避される（IDとパスワードを用いずにログインされる）。</li>
<li>DBサーバ上のファイルアクセス、プログラム実行。</li>
</ul>
</li>
<li>対策
<ul>
<li>静的プレースホルダを利用してSQLを呼び出す。</li>
</ul>
</li>
</ul>
<h4 id="攻撃手法と影響">攻撃手法と影響</h4>
<ul>
<li>エラーメッセージ経由の情報漏洩
<ul>
<li>DB内の任意の情報を取得。</li>
<li>エラーの詳細はログに吐け。</li>
</ul>
</li>
<li>UNION SELECT
<ul>
<li>2つのSQL文の結果の和集合。</li>
<li>これを用いた攻撃が成功すると、一度の攻撃で大量の情報が漏洩する。</li>
</ul>
</li>
<li>認証回避
<ul>
<li>ログイン画面にSQLインジェクションの脆弱性あると、where句が常に成立するようなSQLを注入され、パスワードをしらなくともログイン可能。</li>
</ul>
</li>
<li>データ改竄
<ul>
<li>テーブルのカラムにHTMLやJSを仕込む。</li>
</ul>
</li>
<li>DBエンジンによって可能な攻撃が異なる
<ul>
<li>OSコマンドの実行</li>
<li>ファイル読み出し
<ul>
<li>MySQLは拡張機能<code>LOAD DATA INFILE</code>文によって、ファイルをテーブルに読み込むことが可能。</li>
</ul>
</li>
<li>ファイル書き込み</li>
<li>HTTPリクエストにより他サーバを攻撃</li>
</ul>
</li>
<li>DB中のテーブル名・カラム名の調査方法
<ul>
<li>SQLの標準規格に<code>INFORMATION_SCHEMA</code>というデータベースが規定されているので、その中の<code>tables</code>や<code>columns</code>という仮想的な表を取得可能。</li>
</ul>
</li>
</ul>
<h4 id="脆弱性が生まれる原因">脆弱性が生まれる原因</h4>
<ul>
<li>文字列リテラルのエスケープ漏れ
<ul>
<li><code>'</code>を用いて文字列リテラルからはみ出した文字列をSQL文として認識させ、アプリが呼び出すSQL文を改変する。</li>
</ul>
</li>
<li>数値リテラルに対するSQLインジェクション
<ul>
<li>数値リテラルは数値でない文字が来た時点でそれが終端となる。</li>
<li><code>;</code>を仕込まれ、その後に続く任意のSQL文が実行される。</li>
</ul>
</li>
</ul>
<h4 id="対策">対策</h4>
<ul>
<li>プレースホルダによってSQL文を組み立てる。
<ul>
<li>プレースホルダ : 「場所取り」。SQLにおいては<code>?</code>や<code>$%d</code>。
<ul>
<li>パラメータを安全に割り当てる。</li>
</ul>
</li>
<li>静的プレースホルダ
<ul>
<li>Prepared Statementとも。</li>
<li>値のバインドをDB側で行う。プレースホルダのついたSQL文はそのままDBエンジンに送られ、コンパイルなどの実行準備が行われてSQL文が確定する。</li>
<li>次にバインド値がDBエンジンに送られ、エンジン側で値を当てはめた後にSQL文が実行される。</li>
<li>後からSQL文が改変される可能性が原理的にない。</li>
</ul>
</li>
<li>動的プレースホルダ
<ul>
<li>SQLを呼び出すアプリ側のライブラリ内で、パラメータをバインドしてからDBエンジンに送る。</li>
<li>静的のほうがいい。</li>
</ul>
</li>
</ul>
</li>
<li>アプリ側でSQL文を組み立てる際に、リテラルを正しく構成するなど、SQL文が変更されないようにする。
<ul>
<li>完全な対応が難しいので、プレースホルダの使用を推奨。</li>
</ul>
</li>
</ul>
<h4 id="like述語とワイルドカード">LIKE述語とワイルドカード</h4>
<ul>
<li>LIKE述語の検索パターン
<ul>
<li><code>_</code> : 任意の1文字にマッチ。</li>
<li><code>%</code> : ゼロ文字以上の任意の文字列にマッチ。</li>
<li><code>_</code>, <code>%</code>を文字として検索する場合は、これらをエスケープする必要あり。</li>
</ul>
</li>
<li>エスケープ文字は<code>ESCAPE</code>句で指定。
<ul>
<li>ex. name列に<code>%</code>という文字を含む行を検索する。
<ul>
<li><code>WHERE name LIKE '%#%%' ESCAPE '#'</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="プレースホルダを用いた様々な処理">プレースホルダを用いた様々な処理</h4>
<ul>
<li>検索条件が動的に変わる場合
<ul>
<li>プレースホルダ記号を含んだSQL文を文字列連結により動的に組み立てて、実パラメータはSQL呼び出しの際にバインドする。</li>
</ul>
</li>
<li>様々な列でのソート
<ul>
<li><code>ORDER BY</code>句を外部パラメータで指定させると脆弱性となる。</li>
<li><code>ORDER BY</code>句に連結する前に、ソート列名の妥当性確認を行うことで防御可能。</li>
</ul>
</li>
</ul>
<h4 id="sqlインジェクションの保険的対策">SQLインジェクションの保険的対策</h4>
<ul>
<li>詳細なエラーメッセージの抑止</li>
<li>入力値の妥当性検証</li>
<li>データベースの権限設定</li>
</ul>
<h3 id="重要な処理の際に混入する脆弱性">「重要な処理」の際に混入する脆弱性</h3>
<h4 id="重要な処理">重要な処理</h4>
<ul>
<li>本書では、ログインしたユーザアカウントにより実行する、取り消しできない処理のこと。
<ul>
<li>クレカ決済、パスワード変更など。</li>
</ul>
</li>
</ul>
<h4 id="クロスサイトリクエストフォージェリcsrf-cross-site-request-forgeries">クロスサイト・リクエストフォージェリ（CSRF, Cross-Site Request Forgeries）</h4>
<ul>
<li>発生箇所 : 以下のいずれかのサイト上の「重要な処理」が行われるページ。
<ul>
<li>クッキーのみでセッション管理が行われているサイト。</li>
<li>HTTP認証、TLSクライアント証明書のみでユーザの識別が行われているサイト。</li>
</ul>
</li>
<li>影響を受けるページ : 「重要な処理」をするページに限られる。</li>
<li>影響 : ユーザ権限で「重要な処理」が勝手に実行される。
<ul>
<li>物品購入</li>
<li>SNSや問い合わせをフォームなどへの書き込み</li>
<li>パスワードやメアドの変更</li>
</ul>
</li>
<li>ユーザ関与の度合い : 必要
<ul>
<li>リンクのクリック、罠サイトの閲覧など。</li>
</ul>
</li>
<li>対策
<ul>
<li>「重要な処理」の前に、正規ユーザからのリクエストであるか確認する。</li>
</ul>
</li>
<li>ユーザの情報を盗むわけではない。</li>
</ul>
<h5 id="入力-実行パターンのcsrf攻撃">入力-実行パターンのCSRF攻撃</h5>
<ul>
<li>攻撃の様子を隠すため、見えないiframeを使って罠サイトを作る。
<ul>
<li>iframeの外側（罠サイトのドメイン）から内側（攻撃対象のサイト）の内容は読み取れない。旧パスワードは盗まれない。</li>
<li>ただし、パスワード変更後の情報漏洩はありうる。</li>
</ul>
</li>
<li>脆弱なサイトにログインしているユーザが罠サイトを閲覧する。</li>
<li>攻撃者が用意したパスワード変更処理が実行。セッションIDのクッキー付きでPOSTリクエストが送信される。</li>
<li>パスワード変更処理が受理される。アカウントが乗っ取られる。</li>
<li>反射型XSSとの比較
<ul>
<li>CSRF : 攻撃対象のサーバ側の処理を悪用する。</li>
<li>XSS : ユーザのブラウザ上で実行される。</li>
<li>CSRFは設計段階から対策する必要がある。</li>
<li>開発者の認知度がXSSに比べて低く、対策が進んでいない。</li>
</ul>
</li>
</ul>
<h5 id="確認画面がある場合のcsrf">確認画面がある場合のCSRF</h5>
<ul>
<li>確認画面から実行画面へのデータの受け渡しの方法
<ul>
<li>type属性がhiddenのinput要素を使う。
<ul>
<li>CSRF攻撃
<ul>
<li>確認画面がない場合と同じ。</li>
<li>実行画面がHTTPリクエストとして変更情報（パスワードなど）を受け取ることに変わりがないため。</li>
</ul>
</li>
</ul>
</li>
<li>セッション変数を使う。
<ul>
<li>CSRF攻撃 : 2段階の工程を踏む。iframeを2つ用意する（場合によって工程・iframeはもっと増える）。
<ol>
<li>確認画面に対して変更情報をPOSTしてセッション変数にそれをセットさせる。</li>
<li>タイミングを見計らって（例えば10秒後)、実行画面を呼び出す。</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="ファイルアップロードフォームでのcsrf">ファイルアップロードフォームでのCSRF</h5>
<ul>
<li>HTMLフォームからのファイルアップロードでは、ファイル名やファイルの中身をHTMLファイルから指定できない。</li>
<li>しかし、クロスオリジンに対応したXMLHttpRequestによる攻撃が可能。</li>
<li>攻撃対象がRefererヘッダとOriginヘッダを確認しなければ攻撃成功。</li>
<li>任意のファイルがサーバにアップロードされる。</li>
</ul>
<h5 id="脆弱性が生まれる原因-1">脆弱性が生まれる原因</h5>
<ul>
<li>form要素のaction属性にはどのドメインのURLでも指定可能なこと。
<ul>
<li>罠経由でも攻撃対象にリクエストを送信できる。</li>
</ul>
</li>
<li>クッキーに保管されたセッションIDは、対象サイトに自動的に送信されること。
<ul>
<li>罠経由のリクエストに対しても、認証された状態で攻撃リクエストが送信される。</li>
</ul>
</li>
</ul>
<h5 id="対策-1">対策</h5>
<ul>
<li>CSRF対策の必要なページを区別する。
<ul>
<li>「重要な処理」を行うページはかなり少ない（はず）。すべてのページにCSRF対策を行うと逆に利便性が下がる。</li>
<li>要件定義工程で機能一覧を作成し、CSRF対策の必要な機能にマークする。</li>
<li>基本設計工程で画面遷移図を作成し、CSRF対策の必要なページにマークする。</li>
<li>開発工程でCSRF対策を実装する。</li>
</ul>
</li>
<li>正規ユーザの意図したリクエストを確認できるよう実装する。
<ul>
<li>秘密情報（トークン）の埋め込み
<ul>
<li>フレームワークのトークン機能を使う。</li>
<li>暗号論的疑似乱数を生成する。</li>
<li>GETメソッドで機密情報を送ると、Refererにより外部に漏れる（まあ重要な処理はそもそもPOSTメソッドで送信するべきだが）。</li>
<li>基本的にこれを推奨。</li>
</ul>
</li>
<li>パスワード再入力
<ul>
<li>ただし、ログアウト処理などにもこれを求めるのは利便性が下がる。</li>
</ul>
</li>
<li>Refererヘッダの確認
<ul>
<li>長所 : 他2つに比べて実装量が少なく済む。</li>
<li>短所
<ul>
<li>Refererが送信されないようにしているユーザが、そのページを実行できなくなる。</li>
<li>チェック漏れが生じやすい。</li>
</ul>
</li>
<li>社内システムなどユーザの環境を限定できる、かつ、既存アプリの脆弱性対策に限ってこれを利用するべし。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="csrf攻撃への保険的対策">CSRF攻撃への保険的対策</h5>
<ul>
<li>「重要な処理」の実行後に、ユーザに対して通知メールを送信する。</li>
<li>XSSなどによる成りすましにも早期に気づかせることが可能。</li>
<li>メールは平文なので、重要情報は記載しない。</li>
</ul>
<h4 id="クリックジャッキング">クリックジャッキング</h4>
<ul>
<li>発生箇所 : マウスなどポインティングデバイスの操作のみで「重要な処理」を実行でき、かつ認証を要するページ。</li>
<li>影響を受けるページ : クリックジャッキング脆弱性のあるページのみ。</li>
<li>影響
<ul>
<li>被害者の権限で「重要な処理」が実行させられる。</li>
<li>設定変更、物品購入、掲示板への書き込みなど。</li>
</ul>
</li>
<li>ユーザ関与の度合い
<ul>
<li>必要</li>
<li>攻撃者の罠サイトを閲覧した上で罠ページ上のクリック</li>
</ul>
</li>
<li>対策
<ul>
<li>「重要な処理」の実行ボタンなどがあるページで<code>X-Frame-Options</code>ヘッダを出力する。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-1">攻撃手法と影響</h5>
<ul>
<li>Twitterのウェブインテント機能
<ul>
<li>ウェブインテント : クエリ文字列から投稿内容を指定し、投稿フォームにあらかじめ投稿内容を埋め込みできる機能。</li>
<li>iframe要素を用いて罠と攻撃対象フォームを重ねる。</li>
<li>CSSの<code>z-index</code>を用いて罠画像を奥側、攻撃対象フォームを手前にし、攻撃対象フォームを透明にする。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-2">脆弱性が生まれる原因</h5>
<ul>
<li>HTMLの仕様を悪用した攻撃。アプリ側のバグではない。</li>
</ul>
<h5 id="対策-2">対策</h5>
<ul>
<li><code>X-Frame-Options</code>
<ul>
<li>Microsoftが提唱した仕様。主要ブラウザで愛用されている。</li>
<li>frameおよびiframeでの参照を制限するレスポンスヘッダ。</li>
<li>値
<ul>
<li><code>DENY</code> : frameなどの内側で表示されなくなる。</li>
<li><code>SAMEORIGIN</code> : 同一オリジンのframe/iframeに限り許可。</li>
</ul>
</li>
</ul>
</li>
<li>すべてのページでX-Frame-Optionsを設定しても問題ないので、Webサーバデーモンの設定で常に出力させるのが楽。</li>
</ul>
<h5 id="保険的対策">保険的対策</h5>
<ul>
<li>重要な処理の実行後に、ユーザに通知メールを送信する。</li>
</ul>
<h3 id="セッション管理の不備">セッション管理の不備</h3>
<h4 id="セッションハイジャック">セッションハイジャック</h4>
<ul>
<li>第三者がセッションIDを悪用して成りすますこと。</li>
<li>手法
<ul>
<li>セッションIDの推測
<ul>
<li>自作セッション管理機構の脆弱性</li>
<li>ミドルウェアの脆弱性</li>
</ul>
</li>
<li>セッションIDの盗み出し
<ul>
<li>XSS脆弱性</li>
<li>HTTPヘッダ・インジェクション脆弱性</li>
<li>Refererの悪用によるURL埋め込みのセッションID</li>
<li>ミドルウェアの脆弱性</li>
<li>クッキーのセキュア属性の不備などで、ネットワーク盗聴</li>
</ul>
</li>
<li>セッションIDの強制
<ul>
<li>セッションIDの固定化攻撃</li>
</ul>
</li>
</ul>
</li>
<li>影響
<ul>
<li>ユーザの重要情報の閲覧</li>
<li>ユーザ権限での操作</li>
<li>ユーザアカウントによるメール、ブログなどへの投稿、設定変更など</li>
</ul>
</li>
</ul>
<h4 id="推測可能なセッションid">推測可能なセッションID</h4>
<ul>
<li>発生箇所 : セッションIDを生成している箇所</li>
<li>影響を受けるページ : セッション管理を利用しているページすべて。</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 実績のあるWebフレームワークが提供するセッション管理機構を利用する。</li>
</ul>
<h5 id="攻撃手法と影響-2">攻撃手法と影響</h5>
<ul>
<li>攻撃の段階
<ol>
<li>対象アプリからセッションIDを集める。</li>
<li>セッションIDの規則性の仮設を立てる。</li>
<li>推測したセッションIDを対象アプリで試す。</li>
</ol>
</li>
<li>ありがちなセッションID生成方法
<ul>
<li>ユーザIDやメアド</li>
<li>リモートIPアドレス</li>
<li>日時（unix時間、年月日時分秒の文字列）</li>
<li>乱数</li>
<li>これらの組み合わせ、base64エンコード、ハッシュ値</li>
<li>このうち、ユーザIDや日時は推測可能なので脆弱性となる。</li>
</ul>
</li>
<li>成りすましの影響
<ul>
<li>ユーザ権限が必要な処理を実行される。</li>
<li>ユーザのパスワードまではわからないので、パスワードの再入力を要求すると保険的対策となる。</li>
</ul>
</li>
</ul>
<h5 id="対策-3">対策</h5>
<ul>
<li>Webフレームワークのセッション管理機構を使う。</li>
<li>自作のセッション管理機構を使う必要がある場合
<ul>
<li><code>/dev/urandom</code>を利用する。</li>
</ul>
</li>
</ul>
<h4 id="url埋め込みのセッションid">URL埋め込みのセッションID</h4>
<ul>
<li>発生箇所 : セッションIDを生成している箇所</li>
<li>影響を受けるページ : セッション管理を利用しているページすべて。</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い : 必要。リンクのクリック、メール添付のURL閲覧。</li>
<li>対策 : URL埋め込みのセッションIDを禁止する設定orプログラミング。</li>
</ul>
<h5 id="攻撃手法と影響-3">攻撃手法と影響</h5>
<ul>
<li>URLに埋め込まれていたセッションIDが、罠サイトにRefererとして漏洩する。</li>
<li>攻撃ではなく事故として、ユーザ自身がセッションID付きのURLをSNSなどに投稿する事例もある。</li>
</ul>
<h5 id="セッションidを意図的にurl埋め込みする理由">セッションIDを意図的にURL埋め込みする理由</h5>
<ul>
<li>2000年前後にプライバシー上の理由から「クッキー有害論」が起こり、クッキーを避けようという機運が一部にあった。</li>
<li>ドコモ社の携帯電話ブラウザが過去にクッキーに対応していなかったため。</li>
</ul>
<h5 id="対策-4">対策</h5>
<p>クッキーにセッションIDを保存するよう設定する。</p>
<h4 id="セッションidの固定化">セッションIDの固定化</h4>
<ul>
<li>手順
<ol>
<li>セッションIDを入手する。</li>
<li>被害者に対して、入手したセッションIDを強制する。</li>
<li>被害者が標的アプリにログインする。</li>
<li>攻撃者は、被害者に強制したセッションIDを使って標的アプリにアクセスする。</li>
</ol>
</li>
<li>発生箇所 : セッションIDを生成している箇所</li>
<li>影響を受けるページ : セッション管理を利用しているページすべて。</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い : 大。罠URLの閲覧、本番サイトでの認証。</li>
<li>対策 : ログイン時にセッションIDを変更する。</li>
</ul>
<h5 id="ログイン前のセッションid固定化攻撃">ログイン前のセッションID固定化攻撃</h5>
<ul>
<li>ログイン前のページであっても、セッション変数を使用していると攻撃可能な場合がある。</li>
<li>ログイン確定前に確認画面を表示している場合
<ul>
<li>「戻る」リンクをクリックしたら先程入力した情報がデータがフォームに残すという利便性のため。</li>
</ul>
</li>
</ul>
<h5 id="クッキーのみにセッションidの保存するサイトのセッションid固定化攻撃">クッキーのみにセッションIDの保存するサイトのセッションID固定化攻撃</h5>
<ul>
<li>ブラウザやWebアプリに脆弱性があれば可能。
<ul>
<li>クッキーモンスターバグ</li>
<li>XSS脆弱性</li>
<li>HTTPヘッダ・インジェクション脆弱性</li>
</ul>
</li>
<li>中間者攻撃
<ul>
<li>通信路上に攻撃者が存在すれば、プロキシツールを使ってクッキーを改変可能。</li>
<li>サイト全体がHTTPSで暗号化されていても、平文のHTTPでクッキーを設定すれば、そのクッキーはHTTPSでも有効。</li>
</ul>
</li>
</ul>
<h5 id="対策-5">対策</h5>
<p>セッションIDが外部から強制されるのを完全に防ぐのは困難。なので、そうされるのは許容しつつ、セッションハイジャックは防ぐ。</p>
<ul>
<li>認証後にセッションIDを変更する。</li>
<li>それができない場合はトークンにより対策する。
<ul>
<li>ログイン時にトークンを生成し、クッキーとセッション変数の重宝に記憶させる。</li>
<li>各ページの認証確認時にクッキー上のトークンとセッション変数のトークンを比較。同一である場合のみ認証されていると判断させる。</li>
</ul>
</li>
<li>ログイン前にセッション変数を使用している場合
<ul>
<li>セッション管理機構を使わず、hiddenパラメータで値を引き回す。</li>
</ul>
</li>
</ul>
<h3 id="リダイレクト処理にまつわる脆弱性">リダイレクト処理にまつわる脆弱性</h3>
<h4 id="オープンリダイレクト">オープンリダイレクト</h4>
<p>パラメータにより指定したURLにリダイレクトできる中で、任意のドメインにリダイレクト可能な脆弱性。</p>
<ul>
<li>発生箇所 : 外部から指定したURLにリダイレクト可能な箇所。</li>
<li>影響を受けるページ : Webアプリの特定ページが影響を受けるわけではなく、フィッシング手法により重要情報を盗まれることで、Webアプリのユーザが被害を受ける。
<ul>
<li>フィッシング : 著名なWebサイトなどを偽造したサイトにユーザを誘導し、秘密情報などを入力させる手法。</li>
</ul>
</li>
<li>影響
<ul>
<li>フィッシングサイトに誘導され、重要情報を入力させられる。</li>
<li>デバイスドライバやパッチと称してマルウェアを配布される。</li>
</ul>
</li>
<li>ユーザ関与の度合い : 大。リンクのクリックおよび情報の入力。</li>
<li>対策 : 以下のいずれか。
<ul>
<li>リダイレクト先を固定する。</li>
<li>あらかじめ許可されたドメインにのみリダイレクトするよう制限する。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-3">脆弱性が生まれる原因</h5>
<ul>
<li>以下の両方が成立したら脆弱性が生まれる。
<ul>
<li>リダイレクト先のURLを外部から指定できる。</li>
<li>リダイレクト先のドメイン名のチェック処理がない。</li>
</ul>
</li>
<li>オープンリダイレクトが差し支えない場合
<ul>
<li>以下の両方が成立したら脆弱性ではない。
<ul>
<li>もともと外部ドメインに遷移する仕様。</li>
<li>ユーザにとって外部ドメインに遷移することが自明である。</li>
</ul>
</li>
<li>ex. バナー広告</li>
</ul>
</li>
</ul>
<h5 id="対策-6">対策</h5>
<p>以下のいずれかの対策をとる。</p>
<ul>
<li>リダイレクト先のURLを固定にする。</li>
<li>リダイレクト先のURLを直接指定せず番号指定にする。
<ul>
<li>URLをそのまま指定するのではなく、「ページ番号」の形で指定する。</li>
<li>ページ番号とURLの対応表は、外部から見えないスクリプトやファイル、DBなどで管理する。</li>
</ul>
</li>
<li>リダイレクト先のドメイン名をチェックする。
<ul>
<li>ミスりやすいので上2つを推奨。</li>
</ul>
</li>
<li>外部ドメインの場合はまずクッションページに遷移させる。</li>
</ul>
<h4 id="httpヘッダインジェクション">HTTPヘッダ・インジェクション</h4>
<p>リダイレクトやクッキー発行など、外部からのパラメータを元にHTTPレスポンスヘッダを出力する際に発生する脆弱性。<br>
HTTPにおいて特別な意味をもつ改行を仕込まれることで、被害者のブラウザで以下のどちらかor両方が引き起こされる。</p>
<ul>
<li>任意のレスポンスヘッダの追加</li>
<li>レスポンスボディの偽造</li>
</ul>
<h1 id="heading"></h1>
<ul>
<li>発生箇所 : リダイレクトやクッキー生成など、外部から指定したパラメータに基づいてHTTPレスポンスヘッダを出力している箇所。</li>
<li>影響を受けるページ : 任意のJSスクリプト実行により成りすましされ、すべてのページあ影響を受ける。</li>
<li>影響の種類 : 成りすまし、偽ページの表示、キャッシュ汚染</li>
<li>ユーザ関与の度合い
<ul>
<li>必要</li>
<li>罠ページの閲覧、メール添付のURL閲覧など。</li>
</ul>
</li>
<li>対策 : 以下のいずれか。
<ul>
<li>外部からのパラメータをHTTPレスポンスヘッダとして出力しない。</li>
<li>リダイレクトやクッキー生成の専用ライブラリorAPIを使用し、パラメータ中の改行コードをチェックする。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-4">攻撃手法と影響</h5>
<p>パラメータに改行を挿入することで、HTTPレスポンスヘッダを上書きor追加する。<br>
改行文字のURLエンコードは<code>%0D%0A</code>。</p>
<ul>
<li>外部ドメインへのリダイレクト
<ul>
<li><code>Location</code>レスポンスヘッダ（リダイレクト先）が罠サイトのURLに書き換えられる。</li>
</ul>
</li>
<li>任意のクッキー生成
<ul>
<li>セッションID固定化攻撃との組み合わせで、ユーザの成りすましが行われる。</li>
</ul>
</li>
<li>偽画面の表示
<ul>
<li>改行を2回連続で出力した後のデータがレスポンスボディと見なされることを利用し、偽画面を表示させる。</li>
<li>CSSを工夫することで元の画面は隠せる。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-4">脆弱性が生まれる原因</h5>
<ul>
<li>HTTPレスポンスヘッダはテキスト形式で1行に1つのヘッダが定義可能。</li>
<li>リダイレクト先URLやクッキー値として設定されるパラメータ中に改行を挿入した場合などに、改行がレスポンスとしてそのまま出力されることが原因。</li>
</ul>
<h5 id="対策-7">対策</h5>
<p>外部からのパラメータをHTTPレスポンスヘッダとして出力しないこと。<br>
「外部からのパラメータ」はHTTPリクエストだけでなく、電子メール、ファイル、DBなどを経由したデータの場合もある。</p>
<ul>
<li>リダイレクト先をURLとして直接指定するのではなく、固定にするか番号などで指定する。</li>
<li>Webアプリ開発ツールの提供するセッション変数を使ってURLを受け渡す。</li>
<li>外部からのパラメータをレスポンスヘッダに出力したい場合
<ul>
<li>以下の両方を実施
<ul>
<li>リダイレクトやクッキー生成を専用のAPIに任せる。</li>
<li>ヘッダを生成するパラメータの改行文字をチェックする。
<ul>
<li>URL中の改行はエラーとする。</li>
<li>クッキー値の改行はパーセントエンコードする。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="クッキー出力にまつわる脆弱性">クッキー出力にまつわる脆弱性</h3>
<h4 id="クッキーの不適切な使用">クッキーの不適切な使用</h4>
<ul>
<li>クッキーに保存していい情報 : セッションIDやトークンなど一時的な情報</li>
<li>クッキーに保存すべきでない情報 : ユーザ情報や権限情報</li>
</ul>
<h5 id="クッキーとセッション変数の比較">クッキーとセッション変数の比較</h5>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">クッキー</th>
<th align="left">セッション変数</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">使いやすさ</td>
<td align="left">APIにより設定、取得</td>
<td align="left">変数とほぼ同じように使える</td>
</tr>
<tr>
<td align="left">配列やオブジェクトの格納</td>
<td align="left">アプリ側で文字列に変換する必要あり</td>
<td align="left">通常の変数同様に代入可能な場合が多い</td>
</tr>
<tr>
<td align="left">サイズの制限</td>
<td align="left">厳しい</td>
<td align="left">実用上は無限</td>
</tr>
<tr>
<td align="left">ユーザによる格納情報の直接参照</td>
<td align="left">容易</td>
<td align="left">不可能</td>
</tr>
<tr>
<td align="left">脆弱性などでクッキーが漏洩した際の情報漏洩しやすさ</td>
<td align="left">クッキーが漏洩するとデータも漏洩</td>
<td align="left">漏洩しにくさを制御可能</td>
</tr>
<tr>
<td align="left">ユーザによるデータ改変</td>
<td align="left">容易</td>
<td align="left">不可能</td>
</tr>
<tr>
<td align="left">第三者によるデータ改変</td>
<td align="left">XSSやHTTPヘッダ・インジェクションなどの脆弱性があれば可能</td>
<td align="left">クッキーを改変可能な脆弱性があってもセッション変数は改変不可能</td>
</tr>
<tr>
<td align="left">情報の寿命の制限</td>
<td align="left">容易</td>
<td align="left">セッション限り</td>
</tr>
<tr>
<td align="left">異なるサーバとの情報共有</td>
<td align="left">ドメインが同じなら可能</td>
<td align="left">基本的には不可能</td>
</tr>
</tbody>
</table>
<h4 id="クッキーのセキュア属性不備">クッキーのセキュア属性不備</h4>
<ul>
<li>発生箇所 : セッションIDを含めて、クッキーを生成している箇所すべて</li>
<li>影響を受けるページ : HTTPS通信を利用し、かつ認証のあるページすべて</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い
<ul>
<li>HTTPSのみのサイトの場合は必要（罠リンクのクリックなど）。</li>
<li>HTTPとHTTPS混在のサイトでは不要。</li>
</ul>
</li>
<li>対策 : 以下のいずれか
<ul>
<li>クッキーにセキュア属性を付与する。</li>
<li>セッションIDとは別にセキュア属性つきのクッキーとしてトークンを発行し、ページ毎にトークンを確認する。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-5">攻撃手法と影響</h5>
<ol>
<li>ユーザはHTTPSでクッキーにセキュア属性がない攻撃対象サイトにログインしている。</li>
<li>ユーザが罠サイトを閲覧。</li>
<li>罠サイトからHTTPリクエスト（HTTPSではない）を攻撃対象サイトに発行。</li>
<li>このリクエスト自体はサイト側にBad Requestとして処理されるが、暗号化されていないクッキー値がリクエストにばっちり記載されているので攻撃者に盗聴される。</li>
</ol>
<h5 id="脆弱性が生まれる原因-5">脆弱性が生まれる原因</h5>
<ul>
<li>開発者がセキュア属性について知らない。</li>
<li>セキュア属性をつけるとアプリが動作しなくなる。
<ul>
<li>HTTPとHTTPSが混在している。
<ul>
<li>典型例 : ショッピングサイト</li>
<li>カタログページから商品を選ぶ際はHTTP、決済する段階からHTTPS。</li>
</ul>
</li>
<li>HTTPではセキュア属性のクッキーを受け取れない。</li>
</ul>
</li>
</ul>
<h5 id="対策-8">対策</h5>
<ul>
<li>サイト全体をHTTPSにする常時TLSにした上でクッキーにセキュア属性を付与する。</li>
<li>トークンを用いる。
<ul>
<li>セッションID固定化攻撃の対策と同じ。</li>
<li>トークンを保持するクッキーにセキュア属性をつける。</li>
<li>セッションIDが盗聴されてもHTTPSのページではセッションハイジャックを防げる。</li>
<li>理由
<ul>
<li>トークンは認証成功時に一度だけサーバから発行される。</li>
<li>トークンはHTTPSのページで生成される（サーバ -&gt; ブラウザ）。</li>
<li>トークンは確実に暗号化されてブラウザから送信される（ブラウザ -&gt; サーバ）。</li>
<li>HTTPSのページを閲覧するにはトークンが必須。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="セキュア属性以外の属性値に関する注意">セキュア属性以外の属性値に関する注意</h5>
<ul>
<li>Domain属性
<ul>
<li>デフォの指定しない状態が最も安全。</li>
<li>これを指定するのは複数のサーバでクッキーを共有する場合になるが、セッションIDを共有する意味はない。</li>
</ul>
</li>
<li>Path属性
<ul>
<li>ディレクトリ毎に異なるセッションIDを発行したい場合に指定する。</li>
<li>安全性が高まるわけではない。
<ul>
<li>JSの同一オリジンポリシーはディレクトリ単位ではなく、ホスト名単位なので。</li>
</ul>
</li>
</ul>
</li>
<li>Expires属性
<ul>
<li>通常は設定しない。ブラウザ終了と同時にクッキーが削除される状態にする。</li>
<li>設定すると、ブラウザ終了後も認証状態を維持することが可能。</li>
</ul>
</li>
<li>HttpOnly属性
<ul>
<li>JSから参照不可となる。</li>
<li>XSS攻撃の影響を軽減することも可能。</li>
</ul>
</li>
</ul>
<h3 id="メール送信の問題">メール送信の問題</h3>
<ul>
<li>メールヘッダ・インジェクション
<ul>
<li>メールの宛先や件名などヘッダフィールドに改行を挿入することで、新たなフィールドを追加したり本文を改竄する攻撃。</li>
</ul>
</li>
<li>hiddenパラメータによる宛先保持
<ul>
<li>カスタマイズを簡単に行うことを目的として、メール送信先などをhiddenパラメータとして指定するメール送信用フォームにありがち。</li>
<li>hiddenパラメータを任意のアドレスに改竄され、迷惑メールの送信に悪用される。</li>
<li>送信先メアドなどはサーバ上のファイルやDBなどに保管すべき。</li>
</ul>
</li>
<li>メールサーバによる第三者中継
<ul>
<li>メールサーバ（MTA, Mail Transfer Agent）の設定に問題があると、そのサーバの送信者でも受信者でもない第三者のメールを中継してしまう。</li>
<li>脆弱性診断ツール（NessusやOpenVAS）でチェック可能。</li>
</ul>
</li>
</ul>
<h4 id="メールヘッダインジェクション">メールヘッダ・インジェクション</h4>
<ul>
<li>発生箇所 : メール送信機能のあるページ。</li>
<li>影響を受けるページ : 直接影響を受けるページはない。メールを送られたユーザが影響を受ける。</li>
<li>影響
<ul>
<li>迷惑メールの送信。</li>
<li>メールの宛先や件名、本文の改竄。</li>
<li>ウィルス添付メールの送信。</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : メール送信には専用のライブラリを使用した上で、以下のいずれかを行う。
<ul>
<li>外部パラメータをメールヘッダに含ませない。</li>
<li>含ませる場合は改行を含まないようチェックする。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性は生まれる原因">脆弱性は生まれる原因</h5>
<ul>
<li>メールメッセージの形式
<ul>
<li>ヘッダ
<ul>
<li>各フィールドは改行で区切られる。</li>
<li>宛先、送信元、件名、文字コード、ファイル形式など。</li>
</ul>
</li>
<li>空行</li>
<li>ボディ</li>
</ul>
</li>
<li>改行を挿入して任意のフィールドや本文を追加される。</li>
</ul>
<h5 id="保険的対策-1">保険的対策</h5>
<ul>
<li>メールアドレスをチェックする。</li>
<li>件名をチェックする。</li>
</ul>
<p>メールプロトコル（とくにSMTP）を学習することでさらに理解が深まる。</p>
<h3 id="ファイルアクセスにまつわる問題">ファイルアクセスにまつわる問題</h3>
<h4 id="ディレクトリトラバーサル">ディレクトリ・トラバーサル</h4>
<p>外部パラメータからサーバ上のファイル名を指定できるWebアプリでは、ファイルパスに対するチェックが不十分だと、アプリ側が意図しないファイルに対して閲覧・改竄・削除が可能。</p>
<ul>
<li>発生箇所 : ファイル名を外部から指定できるページ。</li>
<li>影響を受けるページ : すべてのページが脆弱性の影響を受ける。</li>
<li>影響
<ul>
<li>秘密情報の漏洩</li>
<li>データの改竄・削除</li>
<li>任意のスクリプトの実行</li>
<li>アプリの機能停止</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいすれか
<ul>
<li>外部からファイル名を指定できる仕様を避ける。</li>
<li>ファイル名にディレクトリ名が含まれないようにする。</li>
<li>ファイル名を英数字に限定する。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-6">脆弱性が生まれる原因</h5>
<p>以下がすべて成立すること。</p>
<ul>
<li>ファイル名を外部から指定可能。</li>
<li>ファイル名として、絶対パスや相対パスの形で異なるディレクトリを指定可能。</li>
<li>組み立てたファイル名に対するアクセスの可否をチェックしていない。</li>
</ul>
<h5 id="対策-9">対策</h5>
<p>以下のいずれか。</p>
<ul>
<li>外部からファイル名を指定できる仕様を避ける。
<ul>
<li>ファイル名を固定にする。</li>
<li>ファイル名をセッション変数に保持する。</li>
<li>ファイル名を直接指定するのではなく番号などで間接的に指定する。</li>
</ul>
</li>
<li>ファイル名にディレクトリ名が含まれないようにする。
<ul>
<li>OSによるディレクトリ名の違い（<code>/</code>, <code>\</code>, <code>:</code>）を考慮したライブラリを使用する。</li>
<li>ヌルバイトに注意（<code>%00</code>）。</li>
</ul>
</li>
<li>ファイル名を英数字限定にする。</li>
</ul>
<h4 id="意図しないファイル公開">意図しないファイル公開</h4>
<p>秘密ファイルをWebサーバの公開ディレクトリに配置していると、それへのアクセスが可能となってしまう。</p>
<ul>
<li>発生箇所 : Webサイト全体。</li>
<li>影響を受けるページ : 公開されたファイルのみ。</li>
<li>影響 : 重要情報の漏洩。</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策
<ul>
<li>非公開ファイルを公開ディレクトリに配置しない。</li>
<li>保険的に、ディレクトリ・リスティングを無効にする。</li>
</ul>
</li>
</ul>
<h5 id="ディレクトリリスティング">ディレクトリ・リスティング</h5>
<ul>
<li>URLでディレクトリ名を指定した場合にファイル一覧を表示する機能。</li>
</ul>
<h5 id="脆弱性が生まれる原因-7">脆弱性が生まれる原因</h5>
<ul>
<li>ファイルが公開ディレクトリに配置されている。</li>
<li>ファイルに対するURLを知る手段がある。
<ul>
<li>ディレクトリ・リスティングが有効。</li>
<li>ファイル名が類推可能。</li>
<li>エラーメッセージや他の脆弱性によりファイルパスが分かる。</li>
<li>外部サイトからリンクされるなどして検索エンジンに登録される。</li>
</ul>
</li>
<li>ファイルに対するアクセス制限が掛かっていない。</li>
</ul>
<h5 id="対策-10">対策</h5>
<ul>
<li>アプリ設計時に、ファイルの安全な格納場所を決める。</li>
<li>レンタルサーバを契約する際は、非公開ディレクトリが利用可能か確認する。</li>
</ul>
<h3 id="osコマンド呼び出しの際に発生する脆弱性">OSコマンド呼び出しの際に発生する脆弱性</h3>
<h4 id="osコマンドインジェクション">OSコマンド・インジェクション</h4>
<p>外部パラメータから任意のOSコマンドを実行され、やりたい放題される。</p>
<ul>
<li>発生箇所 : シェルを呼び出す機能のある関数を実行している場所。</li>
<li>影響を受けるページ : すべてのページ。</li>
<li>影響
<ul>
<li>秘密情報の漏洩</li>
<li>データの改竄・削除</li>
<li>外部への攻撃</li>
<li>システム停止</li>
<li>etc</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいずれか
<ul>
<li>シェル呼び出し機能のある関数の利用を避ける。</li>
<li>シェル呼び出し機能のある関数には外部からのパラメータを渡さない。</li>
<li>OSコマンドに渡すパラメータを安全な関数によりエスケープする。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-8">脆弱性が生まれる原因</h5>
<ul>
<li>シェル経由でOSコマンドを呼び出す際に、シェルのメタ文字がエスケープされていない場合
<ul>
<li><code>;</code> : コマンドを続けて実行。</li>
<li><code>&amp;</code> : バックグラウンドとフォアグラウンドで実行。</li>
<li><code>&amp;&amp;</code> : 最初のコマンドが成功したら第2のコマンドを実行。</li>
<li><code>||</code> : 最初のコマンドが失敗したら第2のコマンドを実行。</li>
<li><code>` `</code> : バッククォートで囲った文字列をコマンドを実行。</li>
<li><code>|</code> : 第1のコマンドの出力を第2のコマンドの入力にする。</li>
</ul>
</li>
<li>シェル機能を呼び出せる関数を使用している場合
<ul>
<li><code>system</code>, <code>open</code>, <code>exec</code>など。</li>
</ul>
</li>
</ul>
<h5 id="対策-11">対策</h5>
<p>設計フェーズで対策方針を決定する。</p>
<ul>
<li>基本設計フェーズ
<ul>
<li>主要な機能の実装方針を決定する。</li>
<li>極力ライブラリを使用するが、やむを得ない場合はOSコマンドを利用する。</li>
</ul>
</li>
<li>詳細設計フェーズ
<ul>
<li>各機能の詳細実装設計の際に、シェルを呼び出せる関数の使用をできるだけ避ける。</li>
<li>シェル経由の関数しか使えない場合は、パラメータを固定にするか標準入力から指定することを検討する。</li>
</ul>
</li>
</ul>
<h5 id="保険的対策-2">保険的対策</h5>
<ul>
<li>パラメータの検証</li>
<li>アプリの稼働する権限を最小限にする
<ul>
<li>コマンドの実行権限はWebアプリの持つ権限となるので、Webアプリの権限を必要最小限に制限しておく。</li>
<li>外部からの攻撃の多くは、最初に<code>Webshell</code>という遠隔操作用のバックドアコマンドをドキュメントルートにダウンロードして設定する。</li>
<li>ドキュメントルートににWebアプリから書き込み権限がない状態にすれば、Webshell設置による攻撃は成功しない。</li>
<li>ディレクトリ・トラバーサルに対しても有効な対策。</li>
</ul>
</li>
<li>WebサーバのOSやミドルウェアのパッチ適用
<ul>
<li>サーバ内部からOSの脆弱性を突かれるのが最もやばい。</li>
</ul>
</li>
</ul>
<h5 id="webshell">Webshell</h5>
<ul>
<li>OSコマンド・インジェクションをわざと仕込んだスクリプトファイル。</li>
<li>これを攻撃対象のWebサーバにアップロードし、外部パラメータから実行したいコマンドを指定してアクセスする。</li>
</ul>
<h3 id="ファイルアップロードにまつわる問題">ファイルアップロードにまつわる問題</h3>
<ul>
<li>アップロード機能に対するDoS攻撃
<ul>
<li>DoS攻撃（Denial of Service Attack）
<ul>
<li>大量のデータを連続送信することでWebサイトに過大な負荷を掛ける。</li>
</ul>
</li>
<li>対策
<ul>
<li>アップロードファイルの容量制限。</li>
<li>Webサーバデーモンでリクエストボディサイズを絞る。</li>
</ul>
</li>
<li>使用メモリ量やCPU使用時間も考慮する。</li>
</ul>
</li>
<li>アップロードされたファイルをサーバ上のスクリプトとして実行する攻撃</li>
<li>仕掛けを含むファイルをユーザにダウンロードさせる攻撃
<ul>
<li>ユーザのPC上でJSなどのクライアントスクリプトの実行やマルウェア感染が起きる。</li>
</ul>
</li>
<li>閲覧権限のないファイルのアップロード
<ul>
<li>ファイルに対するアクセス制限が掛かっていない。</li>
</ul>
</li>
</ul>
<h4 id="アップロードファイルによるサーバ側スクリプト実行">アップロードファイルによるサーバ側スクリプト実行</h4>
<p>ユーザがアップロードしたファイルが公開ディレクトリに配置される、かつサーバ側で実行可能なスクリプトファイルの場合、OSコマンドインジェクションと同等の影響がある。</p>
<ul>
<li>発生箇所 : ファイルのアップロード機能を提供するページ</li>
<li>影響を受けるページ : すべてのページ</li>
<li>影響
<ul>
<li>秘密情報の漏洩</li>
<li>データの改竄・削除ｍ</li>
<li>外部へのDoS攻撃</li>
<li>システム停止</li>
<li>etc</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいずれか
<ul>
<li>ユーザがアップロードしたファイルは公開ディレクトリに配置せず、スクリプト経由で閲覧させる。</li>
<li>ファイルの拡張子をスクリプト実行の可能性がないものに制限する。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-9">脆弱性が生まれる原因</h5>
<ul>
<li>アップロードしたファイルが公開ディレクトリに保存される。</li>
<li>アップロード後のファイル名として、サーバスクリプトを示す拡張子が指定できる。</li>
</ul>
<h4 id="ファイルダウンロードによるxss">ファイルダウンロードによるXSS</h4>
<p>HTMLやJSスクリプトを仕込んだ画像ファイルやPDFファイルをアップロードして公開、ユーザのブラウザにこれらをHTMLとして認識させ、XSS攻撃を成立させる。</p>
<ul>
<li>発生箇所 : ファイルのアップロード機能、ダウンロード機能</li>
<li>影響を受けるページ : アプリ全体、とくにセッション管理や認証のあるページ。</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い
<ul>
<li>必要</li>
<li>リンクのクリックなど。</li>
</ul>
</li>
<li>対策
<ul>
<li>ファイルの<code>Content-Type</code>を正しく設定する。</li>
<li>レスポンスヘッダ<code>X-Content-Type-Options: nosniff</code>を指定する。
<ul>
<li><code>Conent-Type</code>が<code>text/html</code>でなければJSの実行までは至らなくなる。</li>
</ul>
</li>
<li>ダウンロードを想定したファイルには、レスポンスヘッダとして<code>Content-Disposition: attachment</code>を指定する。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-6">攻撃手法と影響</h5>
<ul>
<li>PDFダウンロード機能によるXSS
<ul>
<li>IE限定。</li>
<li>htmlファイルをPDFと偽装してアップロードし、呼び出すURLに<code>PATH_INFO</code>を追加することでユーザのブラウザ上で任意のJSを実行させる。</li>
</ul>
</li>
</ul>
<h4 id="pdfのformcalcによるコンテンツハイジャック">PDFのFormCalcによるコンテンツハイジャック</h4>
<h5 id="formcalc">FormCalc</h5>
<ul>
<li>PDFに埋め込み可能なスクリプト言語。</li>
<li>Adobe Acrobat Readerに実装されているFormCalcではHTTPリクエストを呼び出し、結果を受け取ることが可能。
<ul>
<li>ここでクッキー付きのリクエストを送らせ、セッションIDをパクる。</li>
</ul>
</li>
<li>Adobe Acrobat Readerプラグインを備えたIEが攻撃対象。</li>
</ul>
<h1 id="heading-1"></h1>
<ul>
<li>発生箇所 : ユーザがアップロードしたPDFファイルをダウンロードする機能</li>
<li>影響を受けるページ : セッション管理や認証のあるページ</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い
<ul>
<li>必要</li>
<li>罠サイトの閲覧など。</li>
</ul>
</li>
<li>対策
<ul>
<li>PDFファイルはブラウザ内で開かずダウンロードを強制する。
<ul>
<li><code>X-Download-Options: noopen</code>で「ファイルを開く」ボタンを非表示にする。</li>
</ul>
</li>
<li>PDFをobject要素やembed要素では開けない仕組みを実装する。</li>
</ul>
</li>
</ul>
<h3 id="インクルードにまつわる問題">インクルードにまつわる問題</h3>
<h4 id="ファイルインクルード攻撃">ファイルインクルード攻撃</h4>
<p>インクルードするファイル名を外部から指定可能な場合に、アプリが意図しないファイルを指定することで攻撃する。</p>
<ul>
<li>発生箇所 : <code>include</code>などによりスクリプトを読み込んでいるページ</li>
<li>影響を受けるページ : すべてのページ</li>
<li>影響
<ul>
<li>情報漏洩</li>
<li>サイト改竄</li>
<li>不正な機能実行</li>
<li>他サイトへの攻撃（踏み台にされる）</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいずれか
<ul>
<li>インクルードするパス名に外部パラメータを含めない。</li>
<li>含めるならば、英数字に限定する。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-7">攻撃手法と影響</h5>
<ul>
<li>ヌルバイトを差し込んで非公開ファイルを読み込ませ、漏洩させる。</li>
<li>リモート・ファイルインクルード攻撃（RFI）
<ul>
<li>PHPには外部サーバのスクリプトをインクルードする機能があった（現在はデフォで無効）。</li>
</ul>
</li>
<li>セッション保存ファイルの悪用
<ul>
<li>ファイル名を予測できる場合
<ul>
<li>ファイルアップロードが可能なサイト</li>
<li>セッション変数の保存先としてファイルを使用しているサイト
<ul>
<li>OSによってセッション情報のデフォルトの保存パスは決まっているので、変更していないと推測される。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="構造化データの読み込みにまつわる問題">構造化データの読み込みにまつわる問題</h3>
<p>シリアライズ : データをバイト列にすること。<br>
デシリアライズ : そのバイト列をデータに戻すこと。</p>
<h4 id="evalインジェクション">evalインジェクション</h4>
<p>文字列をコードとして解釈・実行する機能を利用して外部から送信したスクリプトを実行する攻撃。</p>
<ul>
<li>発生箇所 : スクリプトを解釈して実行できるevalのような機能を利用しているページ。</li>
<li>影響を受けるページ : すべてのページ</li>
<li>影響
<ul>
<li>情報漏洩</li>
<li>サイト改竄</li>
<li>不正な機能実行</li>
<li>他サイトへの攻撃（踏み台）</li>
<li>暗号通貨の採掘（マイニング）</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいずれか
<ul>
<li>evalに相当する機能を使わない。</li>
<li>evalの引数には外部パラメータを含めない。</li>
<li>evalの与える外部パラメータを英数字に制限する。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-8">攻撃手法と影響</h5>
<ul>
<li>式・文の区切り文字 + 任意の式・文 を挿入して攻撃する。</li>
</ul>
<h4 id="安全でないデシリアライゼーション">安全でないデシリアライゼーション</h4>
<p>デシリアライズの際に意図しないオブジェクトがアプリ内に生成され、場合によっては任意コードを実行される。</p>
<ul>
<li>発生箇所 : 外部からの値をデシリアライズ処理しているページ。</li>
<li>影響を受けるページ : すべてのページ</li>
<li>影響
<ul>
<li>情報漏洩</li>
<li>サイト改竄</li>
<li>不正な機能実行</li>
<li>他サイトへの攻撃（踏み台）</li>
<li>暗号通貨の採掘（マイニング）</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいずれか
<ul>
<li>シリアライズ・デシリアライズ機能を使わない。</li>
<li>デシリアライズ処理には外部パラメータを含めない。</li>
</ul>
</li>
</ul>
<h5 id="対策-12">対策</h5>
<ul>
<li>シリアライズ形式ではなくJSON形式でデータを渡す。</li>
<li>クッキーやhiddenパラメータではなく、セッション変数など書き換えできない形でシリアライズ形式のデータを受け渡す。</li>
<li>HMACなどの改竄検知の仕組みを導入してデータが改竄されていないことを確認する。</li>
</ul>
<h4 id="xml外部実体参照xxe">XML外部実体参照（XXE）</h4>
<p>外部実体参照 : 外部ファイルの内容を取り込む機能。<br>
XMLデータを外部から受け取るプログラムは、外部実体参照の形でWebサーバ内部のファイルなどを不正に読み取られる。</p>
<ul>
<li>発生箇所 : XMLを外部から受け取り解析しているページ。</li>
<li>影響を受けるページ : すべてのページ</li>
<li>影響
<ul>
<li>情報漏洩</li>
<li>他サイトへの攻撃（踏み台）</li>
</ul>
</li>
<li>ユーザ関与の度合い : 不要</li>
<li>対策 : 以下のいずれか
<ul>
<li>外部からのデータ受け取りにXMLではなくJSONを用いる。</li>
<li>XMLを解析する際に外部実体参照の機能を無効化する。</li>
</ul>
</li>
</ul>
<h3 id="共有資源やキャッシュに関する問題">共有資源やキャッシュに関する問題</h3>
<h4 id="共有資源">共有資源</h4>
<ul>
<li>複数のプロセス・スレッドから同時に利用されるデータ。</li>
<li>スコープの広い変数、共有メモリ、ファイル、DBなど。</li>
</ul>
<h4 id="競合状態の脆弱性">競合状態の脆弱性</h4>
<ul>
<li>発生箇所 : 共有資源を利用している箇所</li>
<li>影響を受けるページ : アプリ全体である場合が多い。</li>
<li>影響
<ul>
<li>別人の個人情報の表示</li>
<li>DBの不整合</li>
<li>ファイル内容の破壊</li>
<li>etc</li>
</ul>
</li>
<li>ユーザ関与の度合い : 要・不要とも。</li>
<li>対策 : 以下のいずれか
<ul>
<li>可能であれば共有資源の利用を避ける。</li>
<li>共有資源に対する適切な排他制御を行う。</li>
</ul>
</li>
</ul>
<h4 id="キャッシュからの情報漏洩">キャッシュからの情報漏洩</h4>
<ul>
<li>発生箇所 : キャッシュを利用している環境で秘密情報を表示している箇所。</li>
<li>影響を受けるページ : 秘密情報を表示しているページ</li>
<li>影響
<ul>
<li>別人の個人情報の表示</li>
<li>etc</li>
</ul>
</li>
<li>ユーザ関与の度合い : 必要</li>
<li>対策 : キャッシュの設定を適切に実施する。
<ul>
<li>キャッシュ機能を提供するものにはリバースプロキシ、CDN、ロードバランサーなども含まれるので、インフラ管理者との連携が必要。</li>
</ul>
</li>
</ul>
<h5 id="対策-13">対策</h5>
<ul>
<li>アプリ側でキャッシュ制御用の適切なレスポンスヘッダを設定
<ul>
<li><code>Cache-Control</code>レスポンスヘッダ : <code>private, no-store, no-cache, must-revalidate</code>でキャッシュを抑制する。</li>
<li><code>Pragma</code> : <code>no-cache</code></li>
</ul>
</li>
<li>キャッシュサーバ側でキャッシュ制御の適切な設定
<ul>
<li><code>Cache-Control</code>, <code>Expires</code>, <code>SetCookie</code>レスポンスヘッダを無視しないようにする。</li>
</ul>
</li>
</ul>
<h3 id="web-api実装における脆弱性">Web API実装における脆弱性</h3>
<ul>
<li>Web API
<ul>
<li>表示用の画面ではなくデータのみを返す。</li>
<li>盛んになった理由
<ul>
<li>アプリ開発においてJSの重要性が増加。</li>
<li>スマホアプリと通信して機能を提供するサーバ側の実装携帯として適している。</li>
</ul>
</li>
</ul>
</li>
<li>Ajax (Asynchronous JavaScript + XML)
<ul>
<li>もともとXMLをデータの受け渡しに使っていたが、XMLの表現は冗長。</li>
<li>JSのオブジェクトリテラルの形式が注目され、これをデータ交換形式に発展させたJSONを用いるようになった。</li>
</ul>
</li>
<li>JSONP (JSON with Padding)
<ul>
<li>CORSができる前に作られた。</li>
<li>同一オリジンポリシーの枠内で異なるオリジンのサーバからデータを取得する方法。</li>
<li>script要素を使って外部のJSをコールバック関数（引数はJSONデータ）として直接実行することで、Webアプリからデータを取得する。</li>
<li>非推奨。</li>
</ul>
</li>
</ul>
<h4 id="jsonエスケープの不備">JSONエスケープの不備</h4>
<p>エスケープが漏れると意図しないJSがJSONに混入し、不正実行される。</p>
<ul>
<li>発生箇所 : JSONやJSONPを出力するAPI。</li>
<li>影響を受けるページ : Webアプリ全体</li>
<li>影響 : Webサイトのユーザのブラウザ上でのJS実行。</li>
<li>ユーザ関与の度合い : 必要
<ul>
<li>リックのクリック</li>
<li>攻撃者の罠サイトの閲覧など</li>
</ul>
</li>
<li>対策 : JSON生成時に安全なライブラリ関数を利用する。</li>
</ul>
<h5 id="脆弱性が生まれる原因-10">脆弱性が生まれる原因</h5>
<ul>
<li>JSON文字列の生成時に適切なエスケープ処理が行われていない。</li>
<li>JSONの評価にeval関数やJSONPを用いている。</li>
<li>保険的な対策として、JSONPを避け、CORSを用いたWeb APIに移行する。</li>
</ul>
<h4 id="json直接閲覧によるxss">JSON直接閲覧によるXSS</h4>
<p>JSONを返すWeb APIは通常XMLHttpRequestによるアクセスを想定したものだが、APIが返すレスポンスデータをブラウザで直接閲覧させることで攻撃する。</p>
<ul>
<li>発生箇所 : JSONを生成するAPI。</li>
<li>影響を受けるページ : Webアプリ全体</li>
<li>影響
<ul>
<li>Webサイトのユーザのブラウザ上でのJS実行。</li>
<li>偽情報の表示。</li>
</ul>
</li>
<li>ユーザ関与の度合い : 必要
<ul>
<li>罠サイトの閲覧。</li>
<li>メール記載のURL起動。</li>
<li>攻撃者を受けたサイトの閲覧など</li>
</ul>
</li>
<li>対策
<ul>
<li>JSONのMIMEタイプ（<code>Content-Type</code>）を<code>application/json</code>に正しく設定する（必須。古いIEでは無理）。</li>
<li>レスポンスヘッダ<code>X-Content-Type-Options: nosniff</code>を出力する（強く推奨）。</li>
<li><code>&lt;</code>などをエスケープする（IE7以前にも対応）。</li>
</ul>
</li>
</ul>
<h4 id="jsonpのコールバック関数によるxss">JSONPのコールバック関数によるXSS</h4>
<ul>
<li>発生箇所 : JSONPを生成するAPI。</li>
<li>影響を受けるページ : Webアプリ全体</li>
<li>影響
<ul>
<li>Webサイトのユーザのブラウザ上でのJS実行。</li>
<li>偽情報の表示。</li>
</ul>
</li>
<li>ユーザ関与の度合い : 必要
<ul>
<li>罠サイトの閲覧。</li>
<li>メール記載のURL起動。</li>
<li>攻撃者を受けたサイトの閲覧など</li>
</ul>
</li>
<li>対策
<ul>
<li>JSONPのMIMEタイプ（<code>Content-Type</code>）を<code>text/javascript</code>に正しく設定する。</li>
<li>コールバック関数名を検証する。</li>
</ul>
</li>
</ul>
<h4 id="web-apiのcsrf">Web APIのCSRF</h4>
<ul>
<li>GETリクエストによる攻撃
<ul>
<li>GETリクエストで「重要な処理」を受け付けちまってるAPIに、任意に設定したパラメータで攻撃する。</li>
</ul>
</li>
<li>HTMLフォームのPOSTによる攻撃
<ul>
<li>フォームからのPOSTで使える通常のMIMEタイプは以下の3つのみ。
<ul>
<li><code>text/plain</code> : エンコードせずそのまま送信（普通は使用されない）。</li>
<li><code>application/x-www-form-urlencoded</code> : 通常のフォーム。</li>
<li><code>multipart/form-data</code> : ファイルアップロードで用いる形式。</li>
</ul>
</li>
<li>APIサーバが上記3種類のMIMEタイプを想定していたり、JSONなどを想定していてもMIMEタイプのチェックをしていなければ、攻撃される。</li>
</ul>
</li>
<li>クロスオリジン対応のXMLHttpRequestによる攻撃（シンプルなリクエスト）
<ul>
<li>APIサーバがMIMEタイプのチェックをしていなければ攻撃される。</li>
</ul>
</li>
<li>XMLHttpRequestによる攻撃（プリフライトリクエストが必要なケース）</li>
</ul>
<h5 id="対策-14">対策</h5>
<p>おすすめ順。</p>
<ul>
<li>CSRFトークン
<ul>
<li>セッション変数にトークンを保持する。CSRFの項目でも紹介したやり方と同一。</li>
<li>API呼び出しのJSにトークンを渡すには、以下のいずれか。
<ul>
<li>Webページにhiddenパラメータやカスタムデータ属性で保存し、JSから参照する。</li>
<li>CSRFトークンをJSONで返すAPIを用意する。
<ul>
<li>リクエストヘッダには<code>X-CSRF-TOKEN</code>にAPIサーバから渡されたトークンをセットする。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>二重送信クッキー（Double-submit Cookie）
<ul>
<li>トークンをクッキーとして保存しておき、同じ値をリクエストヘッダのパラメータとしてクッキーとは別に送信する方法。</li>
</ul>
</li>
<li>カスタムリクエストヘッダによる対策</li>
</ul>
<h4 id="jsonハイジャック">JSONハイジャック</h4>
<ul>
<li>発生箇所 : JSONを出力するAPIで秘密情報を提供しているもの。</li>
<li>影響を受けるページ : JSONハイジャック脆弱性のあるページのみ。</li>
<li>影響 : 成りすまし</li>
<li>ユーザ関与の度合い : 必要
<ul>
<li>罠サイトの閲覧。</li>
<li>メール記載のURL起動。</li>
<li>攻撃者を受けたサイトの閲覧など</li>
</ul>
</li>
<li>対策
<ul>
<li><code>X-Content-Type-Options: nosniff</code>レスポンスヘッダの付与（推奨）。</li>
<li><code>X-Requested-With: XMLHttpRequest</code>リクエストヘッダの確認。</li>
</ul>
</li>
</ul>
<h4 id="jsonpの不適切な利用">JSONPの不適切な利用</h4>
<ul>
<li>JSONPを使うな。</li>
</ul>
<h4 id="corsの検証不備">CORSの検証不備</h4>
<ul>
<li>オリジンとしてなんでも許可する<code>*</code>を指定する
<ul>
<li>公開情報の提供などではこれでいい。</li>
<li>非公開情報は駄目。オリジンの制限がある場合は、
<ol>
<li>HTTPリクエストの<code>Origin</code>ヘッダを検証し、</li>
<li>レスポンスヘッダ<code>Access-Control-Allow-Origin</code>を明示する。</li>
<li>連携先が多い場合はあえて<code>*</code>を記述し、他の方法で情報漏洩を防ぐ。</li>
</ol>
</li>
</ul>
</li>
<li>オリジンのチェックをわざと緩和してしまう。
<ul>
<li>CORSではXMLHttpRequestの<code>withCredentials</code>プロパティを指定した場合に<code>Access-Control-Allow-Origin</code>ヘッダに指定するオリジンは明示しなければならない。</li>
<li>が、手抜きで<code>Access-Control-Allow-Origin</code>に<code>$_SERVER['HTTP_PRIGIN]</code>なんかをセットしちゃってる。</li>
</ul>
</li>
</ul>
<h4 id="セキュリティを強化するレスポンス">セキュリティを強化するレスポンス</h4>
<p>Web APIに限らない、レスポンスヘッダとして常に出力しておくだけでブラウザのセキュリティを強化する仕組み。</p>
<ul>
<li><code>X-Frame-Options</code>
<ul>
<li>クリックジャッキングやiframeなどを用いた攻撃を防止。</li>
</ul>
</li>
<li><code>X-Content-Type-Options: nosniff</code>
<ul>
<li>ブラウザによるMIMEタイプの解釈を厳密にする。</li>
<li>JSONハイジャックや、MIMEタイプを誤認させる攻撃を防止する。</li>
</ul>
</li>
<li><code>X-XSS-Protection: 1; mode-block</code>
<ul>
<li>XSSフィルタの有効化を強制する。</li>
</ul>
</li>
<li><code>Content-Security-Policy</code>
<ul>
<li>XSS攻撃を緩和する。</li>
<li>最も厳しい設定は<code>default-src 'self'</code></li>
</ul>
</li>
<li><code>Strict-Transport-Security</code> (HTTP Strict Transport Security, HSTS)
<ul>
<li>HTTPSでの接続を強制する。</li>
<li>ただし、オレオレ証明書が使えなくなる、HTTPSをやめることが難しくなる。</li>
</ul>
</li>
</ul>
<h3 id="javascriptの問題">JavaScriptの問題</h3>
<h4 id="dom-based-xss">DOM Based XSS</h4>
<p>JS側の処理の不備が原因となるXSS。</p>
<ul>
<li>発生箇所 : Webアプリ上でJSによりDOMに関わるメソッドを呼び出している箇所</li>
<li>影響を受けるページ : Webアプリ全体</li>
<li>影響
<ul>
<li>Webサイトユーザのブラウザ上でのJS実行。</li>
<li>偽情報の表示。</li>
</ul>
</li>
<li>ユーザ関与の度合い : 必要
<ul>
<li>罠サイトの閲覧。</li>
<li>メール記載のURL起動。</li>
<li>攻撃者を受けたサイトの閲覧など</li>
</ul>
</li>
<li>対策 : 以下のいずれか
<ul>
<li>DOM操作の適切なAPI呼び出し。</li>
<li>HTMLで特別な意味を持つ記号文字をエスケープする。</li>
</ul>
</li>
</ul>
<h5 id="攻撃手法と影響-9">攻撃手法と影響</h5>
<ul>
<li>innerHTMLによるDOM Based XSS
<ul>
<li>フラグメント識別子（URLの<code>#</code>以降）に任意のJSコードを指定して実行する。</li>
<li>JQueryの<code>html()</code>メソッドでも同様の脆弱性あり。</li>
</ul>
</li>
<li>document.writeによるDOM Based XSS</li>
<li>XMLHttpRequestのURL未検証の問題</li>
<li>JQueryのセレクタの動的生成によるXSS</li>
<li>JSスキームによるXSS
<ul>
<li><code>location.href</code>に<code>javascript:</code>など任意の文字列を指定できると攻撃可能。</li>
</ul>
</li>
</ul>
<h5 id="脆弱性が生まれる原因-11">脆弱性が生まれる原因</h5>
<ul>
<li>DOM操作の際に外部から指定されたHTMLタグなどが有効になる機能を用いている。
<ul>
<li>document.write(), document.writeln()</li>
<li>innerHTML, outerHTML</li>
<li>JQueryのhtml()</li>
<li>JQueryのJQuery(), $()</li>
</ul>
</li>
<li>外部指定のJSが動くevalなどの機能を用いている。</li>
<li>XMLHttpRequestのURLが未検証。</li>
<li>location.hrefやsrc属性、href属性のURLが未検証。</li>
</ul>
<h4 id="webストレージの不適切な使用">Webストレージの不適切な使用</h4>
<ul>
<li>Webストレージ
<ul>
<li>クッキーはリクエスト毎にサーバに送信されるが、WebストレージはJSから書き込み、読み出し、削除ができるだけでサーバへの送信は自動では行われない。</li>
<li>localStorage : 永続的なストレージ。</li>
<li>sessionStorage : ブラウザのタブが開いているときだけ保持されるストレージ。</li>
<li>WebアプリにXSS脆弱性があると内容は漏洩する。</li>
</ul>
</li>
</ul>
<h5 id="不適切な利用例">不適切な利用例</h5>
<ul>
<li>秘密情報を保存する。</li>
<li>XSSやpostMessageにより漏洩する。</li>
<li>XSSやpostMessage経由で改竄される。</li>
<li>Webストレージを経由したDOM Based XSS。</li>
</ul>
<h4 id="postmessageの呼び出しの不備">postMessageの呼び出しの不備</h4>
<ul>
<li>postMessage
<ul>
<li>iframeやwindow.openで開いたウィンドウなど、複数のウィンドウが異なるオリジンで協調して動作する環境で、メッセージやデータのやり取りを行う仕組み。</li>
</ul>
</li>
<li>メッセージ送信先の未確認
<ul>
<li>postMessage()の第二引数に<code>*</code>を指定すると、どのオリジンにもデータを送信できてしまう。</li>
<li><code>event.origin</code>を指定するのが安全。</li>
</ul>
</li>
<li>メッセージ送信元の未確認
<ul>
<li><code>onmessage</code>イベントハンドラで<code>event.origin</code>を確認しろ。</li>
</ul>
</li>
</ul>
<h4 id="jsによるオープンリダイレクト">JSによるオープンリダイレクト</h4>
<ul>
<li>リダイレクト先URLを動的に生成している場合に突かれる脆弱性。</li>
<li>対策
<ul>
<li>リダイレクト先のURLを固定にする。</li>
<li>リダイレクト先URLを直接指定せず番号などで指定する。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="5章-代表的なセキュリティ機能">5章 代表的なセキュリティ機能</h2>
<h3 id="認証">認証</h3>
<h4 id="ログイン機能">ログイン機能</h4>
<p>ユーザIDとパスワードをDBに照合して、一致するものがあれば認証されたと見なす機能。</p>
<ul>
<li>攻撃
<ul>
<li>SQLインジェクション攻撃によるログイン機能のバイパス
<ul>
<li>SQLインジェクションで説明した通り。</li>
</ul>
</li>
<li>SQLインジェクションによるパスワード入手</li>
<li>ログイン画面に対するパスワード試行
<ul>
<li>ブルートフォース攻撃 : 文字列の組み合わせをすべて試す。</li>
<li>辞書攻撃 : パスワードに使われやすい文字列集合を辞書として用意し、それを順に試す。</li>
</ul>
</li>
<li>ソーシャルエンジニアリングによるパスワード入手</li>
<li>フィッシングによるパスワード入手
<ul>
<li>偽サイトで入力させる。</li>
</ul>
</li>
</ul>
</li>
<li>影響 : ユーザ権限をすべて利用される。</li>
<li>対策
<ul>
<li>セキュリティバグをなくす
<ul>
<li>SQLインジェクション</li>
<li>セッションID固定化攻撃</li>
<li>クッキーのセキュア属性不備</li>
<li>オープンリダイレクト脆弱性</li>
<li>HTTPヘッダ・インジェクション</li>
</ul>
</li>
<li>パスワードを予測困難なものにする
<ul>
<li>パスフレーズ : 文の形をした長いパスワード</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="パスワード認証を狙った攻撃への対策">パスワード認証を狙った攻撃への対策</h4>
<ul>
<li>アカウントロック
<ul>
<li>ユーザID毎にパスワード間違いの回数を数える。</li>
<li>間違い回数が上限を達するとアカウントをロックし、ログイン不可にする。
<ul>
<li>上限は10回程度がよい。</li>
</ul>
</li>
<li>アカウントロックが発生したら、メールなどで対象ユーザと管理者に通知する。</li>
<li>正常ログインしたら、間違い回数をクリアする。</li>
<li>再有効化
<ul>
<li>一定時間経過（30分など）させる。</li>
<li>管理者がなんらかの方法で本人確認した後に再有効化する。</li>
</ul>
</li>
</ul>
</li>
<li>パスワード認証に対する攻撃のバリエーション
<ul>
<li>辞書攻撃 : ブルートフォースと同じくアカウントロックが有効。</li>
<li>ジョーアカウント探索
<ul>
<li>ユーザIDと同じ文字列をパスワードに設定しているアカウントを探索する。</li>
</ul>
</li>
<li>リバースブルートフォース攻撃
<ul>
<li>パスワードの方を固定して、ユーザIDを取り替えながらログイン試行する。</li>
</ul>
</li>
<li>パスワードスプレー攻撃
<ul>
<li>少数のパスワード候補をIDを変えながら試行する。</li>
</ul>
</li>
<li>パスワードリスト攻撃
<ul>
<li>攻撃対象サイトとは別のサイトから漏洩したIDとパスワードの一覧を用いて試行する。</li>
<li>パスワードリストはブラックマーケットで流通しており、比較的容易に入手可能。</li>
</ul>
</li>
</ul>
</li>
<li>対策
<ul>
<li>二段階認証の実装
<ul>
<li>パスワードの検証が成功した後に、追加の秘密情報を要求する。
<ul>
<li>メールやSMSで送られる数字。</li>
<li>スマホアプリなどで生成される数字。
<ul>
<li>TOTP (Time-based One Time Password) がベース。RFC6238により規定。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>積極的なパスワードチェック
<ul>
<li>パスワード登録時に、ありがちなパスワードやユーザIDと同じパスワードを拒否。</li>
</ul>
</li>
<li>ログイン失敗率の監視
<ul>
<li>急速に上昇した場合は、該当するリモートIPアドレスとの通信遮断を行う。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="パスワードの保存方法">パスワードの保存方法</h4>
<ul>
<li>DBをまるごと暗号化する製品
<ul>
<li>透過的データ暗号化（TDE, Transparent Data Encryption）</li>
<li>DBを構成するファイルやバックアップメディアの盗聴、クラウド業者への漏洩を防止する。</li>
<li>SQLインジェクションには無力。</li>
</ul>
</li>
<li>メッセージダイジェスト
<ul>
<li>ハッシュ関数
<ul>
<li>任意の長さのデータ（ビット列）を固定長のデータ（メッセージダイジェスト or ハッシュ値）に圧縮する関数。</li>
<li>暗号学的ハッシュ関数 : 以下の要件を満たすもの。
<ul>
<li>原像計算困難性（一方向性） : ハッシュ値から元のデータに復元することが現実的な時間内では困難。</li>
<li>第2原像計算困難性（弱衝突耐性） : 元データと同じハッシュ値をもつ別のデータを見つけることが、現実的な時間内では困難。</li>
<li>衝突困難性（強衝突耐性） : 同じハッシュ値をもつ2つのデータを見つけることが困難。</li>
</ul>
</li>
</ul>
</li>
<li>登録時はパスワードをハッシュ値の状態でDBに保存し、ログイン時にはハッシュ値のまま照合する。</li>
</ul>
</li>
<li>攻撃
<ul>
<li>オフラインブルートフォース攻撃
<ul>
<li>ハッシュ値から元のパスワードを探索する際に、攻撃対象サーバに接続せずに行う。</li>
<li>パスワードの文字数・文字種制限や、高速だが耐性のしょぼいハッシュ関数が原因で、現実的な時間内で割り出されてしまう。</li>
</ul>
</li>
<li>レインボーテーブル
<ul>
<li>パスワードのハッシュ値をあらかじめ総当りで算出して逆引き表にしておく。</li>
<li>文字種と文字数の制限毎に作成する。</li>
<li>市販されている。</li>
</ul>
</li>
<li>DB内にパスワード辞書を作られる
<ol>
<li>攻撃者がダミーのユーザを多数登録する。</li>
<li>SQLインジェクションなどでDBの内容を持ち出す。</li>
<li>パスワードのハッシュ値を調べ、ダミーユーザと正規ユーザのパスワードを照合。</li>
<li>ダブリがあれば正規ユーザのパスワードが判明したことになる。</li>
</ol>
</li>
</ul>
</li>
<li>対策
<ul>
<li>ソルト
<ul>
<li>レインボーテーブル対策。</li>
<li>元データに追加する文字列。</li>
<li>見かけのパスワードを長くし、ユーザ毎に異なる乱数にすることで、パスワードが同じでも異なるハッシュ値が生成される。</li>
<li>ソルトとパスワードを含めて、最低でも20文字は必要。</li>
</ul>
</li>
<li>ストレッチング
<ul>
<li>ブルートフォース攻撃対策。ソルトを使ってもハッシュの計算時間がさほど変わらないため。</li>
<li>ハッシュ計算を繰り返し行う。</li>
<li>パスワード保存に適した遅いハッシュ関数を用いる。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="自動ログイン">自動ログイン</h4>
<ul>
<li>自動ログインを許容しても良い理由
<ul>
<li>Webの利用が浸透した結果、ログイン状態を継続することを前提としたサービスが増加した。</li>
<li>頻繁にログイン・ログアウトが要求されると、ユーザが単純なパスワードをつけがちで、逆に危険性が増す。</li>
</ul>
</li>
<li>危険な実装例
<ul>
<li>ユーザ名と自動ログインのフラグを平文でクッキーに設定する。
<ul>
<li>ユーザ自身がクッキーのユーザ名を変更することで別人としてログインできてしまう。</li>
</ul>
</li>
<li>だからってパスワードなど秘密情報もクッキーに設定すると、XSS脆弱性があった場合に被害が甚大化する。</li>
</ul>
</li>
<li>安全な実装方法
<ul>
<li>セッションの寿命を延ばす
<ul>
<li>クッキーにExpires属性を設定する。</li>
<li>ユーザがサーバに自動ログインフラグを送信するたびに寿命を（例えば）一週間後に設定する。
<ul>
<li>こうすれば、一週間以内にサイトに訪れつづければ、セッションは持続する。</li>
</ul>
</li>
</ul>
</li>
<li>トークンを使う
<ul>
<li>これを推奨。
<ul>
<li>自動ログインを選択しないユーザに影響を与えない。</li>
<li>複数端末からログインしている場合に一斉にログアウト可能。</li>
<li>管理者が、特定ユーザのログイン状態をキャンセル可能。</li>
<li>クライアント側に秘密情報が渡らないので解析される恐れなし。</li>
</ul>
</li>
<li>自動ログイン情報テーブル（カラムはユニークトークン、ユーザID、有効期限）で管理する。</li>
<li>ログイン時にトークンを生成。上記テーブルの行を作成し、クッキーにも同じトークンを付与してユーザに返す。</li>
<li>ログアウト時に上記テーブルの該当行を削除。</li>
</ul>
</li>
<li>認証チケットを使う
<ul>
<li>認証情報をサーバ外に持ち出せるようにしたもの。</li>
<li>ex. WindowsのKerberos認証。</li>
<li>複数のサーバをまたがって認証情報を共有したいときに使う。</li>
<li>独自実装するのではなく、OpenID Connectなどの認証基盤を利用する。</li>
</ul>
</li>
</ul>
</li>
<li>デメリット
<ul>
<li>認証状態が長く続くため、XSSやCSRFなどの受動的攻撃のリスクが高まる。</li>
</ul>
</li>
</ul>
<h4 id="ログインフォーム">ログインフォーム</h4>
<ul>
<li>パスワード入力欄はマスク表示する。
<ul>
<li>type属性がpasswordのinput要素を使う。</li>
</ul>
</li>
<li>HTTPSを利用する。</li>
</ul>
<h4 id="エラーメッセージの要件">エラーメッセージの要件</h4>
<ul>
<li>IDとパスワードのどちらかが間違いか分かるとまずい理由
<ul>
<li>総当たり攻撃の探索範囲が一気に絞られるから。</li>
</ul>
</li>
<li>IDとパスワードを二段階で入力するサイトの増加
<ul>
<li>従来のセキュリティの常識には反するが、ログイン操作自体はやりやすい。</li>
<li>ログイン認証がめんどくなると、ユーザは安易なパスワードをつけがちになる。</li>
<li>セキュリティ面を二段階認証などで補う。</li>
</ul>
</li>
</ul>
<h4 id="ログアウト機能">ログアウト機能</h4>
<ul>
<li>副作用があるのでPOSTメソッドでリクエストする。</li>
<li>セッションを破棄する。</li>
<li>必要な場合、CSRF対策の対象とする。</li>
</ul>
<h3 id="アカウント管理">アカウント管理</h3>
<h4 id="ユーザ登録">ユーザ登録</h4>
<ul>
<li>混入しやすい脆弱性
<ul>
<li>SQLインジェクション</li>
<li>メールヘッダ・インジェクション</li>
</ul>
</li>
<li>メールアドレスの受信確認
<ul>
<li>メアドを登録・変更する際は、登録されたメアドに送信されるメールをユーザ自身が受信できることを確認すべき。</li>
<li>その方法は以下のいずれか。
<ul>
<li>メールにトークン付きURLを添付し、そのURLから処理を継続する。
<ul>
<li>登録完了するまで、トークンとメアドのペアをDBに保存しておく。</li>
</ul>
</li>
<li>メアドを入力した後、トークン（確認番号）入力画面に遷移。トークンは、指定メアドにメール送信される。
<ul>
<li>トークンはセッション変数に保存しておく。</li>
<li>こちらを推奨。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ユーザIDの重複防止
<ul>
<li>テーブル定義のユーザIDの列に一意制約をつける。</li>
</ul>
</li>
<li>ユーザの自動登録への対処
<ul>
<li>CAPTCHA : 文字を歪ませた画像を表示し、ユーザに入力させる。</li>
<li>reCAPTCHA : ユーザのマウス操作から人間化自動応答かを判断。「私はロボットではありません」。</li>
<li>パズル認証 : パズルピースをユーザに埋めさせる。</li>
</ul>
</li>
</ul>
<h4 id="パスワード変更">パスワード変更</h4>
<ul>
<li>混入しやすい脆弱性
<ul>
<li>SQLインジェクション</li>
<li>CSRF</li>
</ul>
</li>
<li>現在のパスワードを確認すること
<ul>
<li>セッションハイジャックされた状態で第三者がパスワード変更するのを防ぐ。</li>
</ul>
</li>
<li>パスワード変更時のメール通知
<ul>
<li>CSRFの保険的対策。</li>
</ul>
</li>
</ul>
<h4 id="メールアドレスの変更">メールアドレスの変更</h4>
<ul>
<li>混入しやすい脆弱性
<ul>
<li>SQLインジェクション</li>
<li>CSRF</li>
<li>セッションハイジャック</li>
</ul>
</li>
<li>機能面の対策
<ul>
<li>メールの受信確認</li>
<li>再認証</li>
<li>メール通知（新旧両方のアドレスに対して行う）</li>
</ul>
</li>
</ul>
<h4 id="パスワードリセット">パスワードリセット</h4>
<p>ユーザがパスワードを忘れた際になんらかの方法でパスワードを回復する仕組み。</p>
<ul>
<li>管理者向けパスワードリセット機能
<ul>
<li>ユーザからの問い合わせでリセットする。</li>
<li>順序
<ol>
<li>問い合わせを受け付け、ユーザの本人確認を行う。
<ul>
<li>電話や書面などで。</li>
</ul>
</li>
<li>管理者がパスワードをリセットし、ユーザに仮パスワードを伝える。
<ul>
<li>画面に表示せず、メールで通知。</li>
<li>仮パスワードでの権限は、パスワード変更のみが行える。</li>
</ul>
</li>
<li>ユーザは仮パスワードでログインし、直ちにパスワードを変更する。</li>
</ol>
</li>
</ul>
</li>
<li>ユーザ向けパスワードリセット機能
<ul>
<li>本人確認の方法
<ul>
<li>登録済みメアドにメールを送る。</li>
<li>加えて、二段階認証に用いるスマホアプリの生成する数字を確認。</li>
</ul>
</li>
<li>パスワードの通知方法
<ul>
<li>非推奨
<ul>
<li>現在のパスワードをメール通知。
<ul>
<li>「暗号化してねえの？」</li>
</ul>
</li>
<li>パスワード変更画面のURLをメール通知。</li>
</ul>
</li>
<li>推奨
<ul>
<li>仮パスワードを発行してメール通知。
<ul>
<li>第三者に仮パスワードをパクられて変更されても正規ユーザに通知メールが送信されるので気づきやすい。</li>
</ul>
</li>
<li>パスワード変更画面に直接遷移。
<ul>
<li>確認トークンを入力させて遷移する。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="アカウントの停止">アカウントの停止</h4>
<p>アカウントの停止・再有効化は管理者機能として実装。</p>
<ul>
<li>停止すべき状況
<ul>
<li>ユーザ本人からの依頼</li>
<li>不正アクセスを受けている状況</li>
<li>ユーザが利用者規約に反している</li>
</ul>
</li>
</ul>
<h4 id="アカウントの削除">アカウントの削除</h4>
<ul>
<li>パスワードの確認（再認証）を要求する。</li>
</ul>
<h3 id="認可">認可</h3>
<p>認証されたユーザに権限を与えること。</p>
<h4 id="認可不備の典型例">認可不備の典型例</h4>
<ul>
<li>情報リソースのURLを知っていると認証無しで情報閲覧できる</li>
<li>情報リソースのIDを変更すると権限外の情報が参照できる
<ul>
<li>URLにIDを埋め込んでいる。</li>
<li>POSTパラメータ（hiddenパラメータ）やクッキーに保持していても同様。</li>
</ul>
</li>
<li>メニューの表示・非表示のみで制御している</li>
</ul>
<h4 id="認可制御の要件定義">認可制御の要件定義</h4>
<ul>
<li>権限マトリクス表を控えておく。
<ul>
<li>ユーザと権限の対応表。</li>
</ul>
</li>
<li>ロール
<ul>
<li>「システム管理者」「企業管理者」「一般ユーザ」などの役割。</li>
<li>ロールを使わずadminやrootなどで管理者を示すユーザを作るのは非推奨。
<ul>
<li>管理者が複数存在したら、どの担当者か後で追跡できない。</li>
<li>管理者パスワードを複数人が知っていることになり、事故りやすい。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="認可制御の正しい実装">認可制御の正しい実装</h4>
<ul>
<li>ユーザ情報は、外部から書き換えできないセッション変数に保持する。</li>
<li>セッション変数に格納したユーザIDを基準に権限をチェックする。</li>
<li>権限情報をクッキーやhiddenパラメータなどに保持しない。
<ul>
<li>外部から書き換え可能だから。</li>
</ul>
</li>
</ul>
<h3 id="ログ出力">ログ出力</h3>
<ul>
<li>目的
<ul>
<li>攻撃や予兆をログから把握し、早期に対策するため。</li>
<li>攻撃や事故の事後調査のため。</li>
<li>アプリの運用監査のため。</li>
</ul>
</li>
<li>ログの種類
<ul>
<li>Webサーバ（Apache, nginx, IISなど）のログ</li>
<li>DBのログ</li>
<li>アプリケーションのログ
<ul>
<li>エラーログ
<ul>
<li>画面にはユーザ向けのエラー情報を表示。</li>
<li>詳細はログに吐く。</li>
</ul>
</li>
<li>アクセスログ
<ul>
<li>正常・異常ともにログに吐く。</li>
<li>各種法令やガイドラインでも要求されている。</li>
</ul>
</li>
<li>デバッグログ
<ul>
<li>本番環境ではオフにしておく。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ログ出力の要件">ログ出力の要件</h4>
<ul>
<li>記録すべきイベント
<ul>
<li>ログイン・ログアウト（失敗も含む）</li>
<li>アカウントロック</li>
<li>ユーザ登録・削除</li>
<li>パスワード変更</li>
<li>重要情報の参照</li>
<li>重要な操作（購入、送金、メール送信など）</li>
</ul>
</li>
<li>出力項目
<ul>
<li>4W1H を意識する。</li>
<li>アクセス日時</li>
<li>リモートIPアドレス</li>
<li>ユーザID</li>
<li>アクセス対象（URL、ページ番号、スクリプトIDなど）</li>
<li>操作内容（閲覧、変更、削除）</li>
<li>捜査対象（リソースIDなど）</li>
<li>操作結果（成功、失敗、処理件数など）</li>
</ul>
</li>
<li>出力フォーマットは統一しておく。監査などでシェルによるフィルタかけるときに便利なので。</li>
<li>保護
<ul>
<li>パスワードやクレカ情報は吐かない。</li>
<li>可能であれば、ログの保存先サーバはWebサーバやDBサーバとは別にし、サイト管理者とは別にログ管理者を割り当てる。</li>
</ul>
</li>
<li>出力先
<ul>
<li>DBやファイル、可能であれば専用のサーバ。</li>
</ul>
</li>
<li>保管期間
<ul>
<li>定期的にログファイルを暗号化して長期保管に適した別のメディアに記録。</li>
</ul>
</li>
<li>サーバの時刻合わせ
<ul>
<li>Webサーバ、アプリ、DB、メールなど。</li>
<li>NTP (Network Time Protocol) 各サーバの時刻を同期させる。</li>
</ul>
</li>
<li>実装
<ul>
<li>ログ出力用のライブラリを使う。</li>
<li>ログレベル
<ul>
<li>fatal</li>
<li>error</li>
<li>warn</li>
<li>info</li>
<li>debug</li>
<li>trace</li>
</ul>
</li>
<li>開発環境ではdebug以上、本番環境ではinfo以上を出力。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="6章-文字コードとセキュリティ">6章 文字コードとセキュリティ</h2>
<p>文字コードは、文字集合と文字エンコーディング（文字符号化方式）からなる。</p>
<ul>
<li>文字集合
<ul>
<li>Unicode
<ul>
<li>当初は16bit、現在は21bitに拡張。</li>
<li>Unicodeでの文字の符号をスカラ値と呼ぶ。<code>U+XXXX</code>で表す。<code>XXXX</code>は4~16桁の16進数。</li>
</ul>
</li>
</ul>
</li>
<li>文字エンコーディング
<ul>
<li>UTF-8
<ul>
<li>bit長 : 7bit</li>
<li>US-ASCIIと互換性あり。</li>
<li>符号化後の文字データは1~4byteの可変長。</li>
<li>文字列中の1byteに着目した場合に、文字の先頭なのか後続バイトなのかは直ちに判断可能。</li>
<li>非最短形式の問題
<ul>
<li>非最短形式 : 2byte以上の文字</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="脆弱性">脆弱性</h3>
<ul>
<li>文字エンコーディングとして不正なバイト列による脆弱性</li>
<li>文字エンコーディングの扱いの不備による脆弱性</li>
<li>文字集合の変更に起因する脆弱性
<ul>
<li>Unicodeの円記号を他の文字集合に変更した際に、処理系によってはバックスラッシュに変換されるために起こる脆弱性。</li>
</ul>
</li>
</ul>
<h3 id="対策-15">対策</h3>
<ul>
<li>アプリ全体を通して文字集合を統一する。
<ul>
<li>Unicodeで統一する。</li>
</ul>
</li>
<li>入力時に不正な文字エンコーディングをエラーにする。</li>
<li>処理の中で文字エンコーディングを正しく扱う。
<ul>
<li>マルチバイト文字に対応した処理系・関数のみを使う。</li>
<li>関数の処理として文字エンコーディングを明示する。</li>
</ul>
</li>
<li>出力時に文字エンコーディングを正しく指定する。
<ul>
<li>HTTPレスポンスヘッダのContent-TypeをUTF-8にする。</li>
<li>DBの文字エンコーディングをUTF-8に設定する。
<ul>
<li>MySQLの<code>utf8</code>は3byteまで対応。4byteまで対応の完全なUTF-8である<code>utf8mb4</code>を推奨。</li>
</ul>
</li>
<li>DBが一貫してUnicodeで設定されているかをテストする方法
<ul>
<li>「尾骶骨」テスト
<ul>
<li>「尾骶骨」という文字列をDBに登録したあと、画面に表示する。</li>
<li>「尾骶骨」と入力された通りに表示できたらOK。</li>
<li>それ以外はNG。</li>
</ul>
</li>
<li>「つちよし」テスト
<ul>
<li>「𠮷」という文字が正しく表示できればOK。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>文字エンコーディングは明示的に指定する。</li>
</ul>
<hr>
<h2 id="7章-脆弱性診断入門">7章 脆弱性診断入門</h2>
<ul>
<li>Webサイトに対する脆弱性診断
<ul>
<li>プラットフォーム診断
<ul>
<li>サーバやネットワーク機器に既知の脆弱性がないかを調べる。</li>
<li>診断対象はOSやミドルウェアなど。</li>
<li>診断ツール（脆弱性スキャナ）を使う。</li>
<li>etc. NMap, OpenVAS</li>
</ul>
</li>
<li>アプリケーション診断
<ul>
<li>Webアプリに対して未知の脆弱性がないかを調べる。</li>
<li>動的診断（ブラックボックス診断）
<ul>
<li>Webアプリを実際に動かす。</li>
</ul>
</li>
<li>ソースコード診断（ホワイトボックス診断）
<ul>
<li>Webアプリを動かさず、ソースコードを確認して診断する。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Nmap : セキュリティ検査ソフト。ポートスキャンとかいろいろ。</li>
<li>OpenVAS : オープンソースの脆弱性診断ツール。</li>
</ul>
<hr>
<h2 id="8章-webサイトの安全性を高めるために">8章 Webサイトの安全性を高めるために</h2>
<h3 id="webサーバへの攻撃経路と対策">Webサーバへの攻撃経路と対策</h3>
<ul>
<li>基盤ソフトウェアの脆弱性をついた攻撃
<ul>
<li>Webサーバデーモンやネットワーク機器の脆弱性</li>
</ul>
</li>
<li>不正ログイン
<ul>
<li>サーバに対してポートスキャンを行い有効なポート番号や稼働しているサービスを調べ、辞書攻撃などでパスワードを調べる。</li>
<li>クラウドのコントロールパネルのフィッシングサイト</li>
</ul>
</li>
<li>対策
<ul>
<li>
<p>適切なサーバ基盤を選定する</p>
<table>
<thead>
<tr>
<th align="left">セキュリティ施策</th>
<th align="left">Iaas / VPS / 専用サーバ</th>
<th align="left">Paas / レンタルサーバ</th>
<th align="left">Saas</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">プラットフォームのパッチ適用</td>
<td align="left">利用者</td>
<td align="left">事業者</td>
<td align="left">事業者</td>
</tr>
<tr>
<td align="left">アプリケーションの脆弱性対処</td>
<td align="left">利用者</td>
<td align="left">利用者</td>
<td align="left">事業者</td>
</tr>
<tr>
<td align="left">パスワード管理</td>
<td align="left">利用者</td>
<td align="left">利用者</td>
<td align="left">利用者</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>機能提供に不要なソフトウェアは稼働させない</p>
</li>
<li>
<p>脆弱性の対処をタイムリーに行う</p>
<ul>
<li>上流設計時に以下を行う
<ul>
<li>サポートの期限を確認</li>
<li>パッチ適用の方法を決定</li>
</ul>
</li>
<li>運営開始後は以下を行う
<ul>
<li>脆弱性情報を監視</li>
<li>脆弱性を確認したらパッチの提供状況や回避策を調べ、対処計画を立てる</li>
<li>脆弱性対処を実行
<ul>
<li>該当するソフトウェアが稼働しているか確認</li>
<li>脆弱性を解決したバージョンにバージョンアップする</li>
<li>回避策を実施する</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>一般公開する必要のないポートやサービスはアクセス制限する</p>
<ul>
<li>sshdなど</li>
<li>外部からは専用線かVPN経由でのみ接続する</li>
<li>特定のIPアドレスからのみ接続を許可する
<ul>
<li>ルータやファイアウォールで設定する</li>
<li>サーバOSの機能（iptables, firewalldなど）で制限する</li>
<li>ソフトウェアのアクセス制限機能により制限する</li>
</ul>
</li>
<li>ポートスキャンでアクセス制限の状態を確認する</li>
</ul>
</li>
<li>
<p>認証の強度を高める</p>
<ul>
<li>TelnetサーバとFTPサーバを削除or停止し、SSH系サービスのみを稼働させる</li>
<li>SSHサーバの設定によりパスワード認証を停止し、公開鍵認証のみにする</li>
<li>クラウドサービスの管理者アカウントは担当者毎に割り当て、可能なら二段階認証を設定する
<ul>
<li>フィッシング対策</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="成りすまし対策">成りすまし対策</h3>
<h4 id="ネットワーク的な成りすましの手口">ネットワーク的な成りすましの手口</h4>
<ul>
<li>DNSに対する攻撃
<ul>
<li>ドメイン名を管理販売するレジストリやレジストラ（ドメイン名の販売代理店）を狙った攻撃
<ul>
<li>レジストラのサイトを乗っ取り、ドメイン名の登録情報を書き換えて、権威DNSサーバを差し替える。</li>
</ul>
</li>
<li>DNSサーバに対する攻撃によりDNSの設定内容を書き換える</li>
<li>DNSキャッシュポイズニング攻撃
<ul>
<li>Webユーザが参照しているDNSキャッシュサーバに対して再帰問い合わせを行い、本物のDNSサーバが応答を返す前に偽の応答を送り込む手法。</li>
</ul>
</li>
<li>失効したドメイン名を第三者が購入して悪用する</li>
</ul>
</li>
<li>ARPスプーフィング
<ul>
<li>ARP (Address Resolution Protocol) の偽応答を返すことでIPアドレスを偽装する手法。</li>
<li>対象サーバがゲートウェイのIPアドレスに対するMACアドレスを要求（ARP要求）する際に、偽のARP応答を返しゲートウェイに成りすますことですべてのパケットを経由させる。</li>
</ul>
</li>
</ul>
<h4 id="webサイトの成りすまし対策">Webサイトの成りすまし対策</h4>
<ul>
<li>ネットワーク的な対策
<ul>
<li>同一セグメント内に脆弱なサーバを置かない
<ul>
<li>ARPスプーフィング攻撃の影響は同一セグメント内に限られる。</li>
</ul>
</li>
<li>DNS運用の強化</li>
</ul>
</li>
<li>TLSの導入
<ul>
<li>TLS
<ol>
<li>通信回線の暗号化</li>
<li>第三者機関（CA）によるドメイン名の正当性の証明</li>
</ol>
</li>
<li>サーバ証明書（安い順）
<ul>
<li>ドメイン認証証明書 : 組織名までは認証しない。
<ul>
<li>Let&rsquo;s Encryptは無料。</li>
</ul>
</li>
<li>組織認証証明書 : 組織名欄に企業名、団体名、個人名が入る。</li>
<li>EV SSL証明書 : 組織の実在性を確認する（成りすまし判定が容易になる）。</li>
</ul>
</li>
</ul>
</li>
<li>確認しやすいドメイン名の採用
<ul>
<li>属性型JPドメイン名が適している。
<ul>
<li>.CO.JP, .GO.JPなど。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="盗聴改竄対策">盗聴・改竄対策</h3>
<h4 id="盗聴改竄の経路">盗聴・改竄の経路</h4>
<ul>
<li>無線LANの盗聴・改竄
<ul>
<li>暗号化されていない</li>
<li>WEPのように解読方法が解明している</li>
<li>共通のパスフレーズを利用する公衆無線LAN</li>
<li>偽のアクセスポイントの設置</li>
</ul>
</li>
<li>ミラーポートの悪用
<ul>
<li>ミラーポート
<ul>
<li>スイッチ上の指定したポートを流れるパケットをコピー（ミラーリング）するためのポート。</li>
<li>ネットワーク上に流れるデータを監視するための機能。</li>
</ul>
</li>
<li>ミラーポートのないスイッチの場合は、リピーターハブを経由させる方法で盗聴が可能。</li>
</ul>
</li>
<li>プロキシサーバの悪用
<ul>
<li>既存のプロキシを利用したり、通信路上にプロキシを設置したりすることで、HTTPを盗聴・改竄する。</li>
</ul>
</li>
<li>偽のDHCPサーバ
<ul>
<li>DNSやデフォルトゲートウェイのIPアドレスを偽装する。</li>
</ul>
</li>
<li>ARPスプーリングとDNSキャッシュポイズニング
<ul>
<li>ユーザからの通信を攻撃者が管理するルータやリバースプロキシに中継させる。</li>
<li>リバースプロキシ : 特定のサーバへのリクエストが必ず通過されるように設置されたプロキシサーバ。
<ul>
<li>ロードバランサー : 負荷分散が主なので、複数サーバの存在が前提。</li>
<li>リバースプロキシ : サーバにとっての代理人（通常のプロキシはクライアントの代理人）。複数サーバに分散させることもできるが、主な役割はセキュリティ向上やキャッシュなど。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="中間者攻撃">中間者攻撃</h4>
<ul>
<li>中間者攻撃（man-in-the-middle attack）
<ul>
<li>頭頂葉の機器により通信を中継させ、情報を盗聴・改竄する。通信路が暗号化されていても復号し、再度暗号化する。</li>
</ul>
</li>
</ul>
<h4 id="対策-16">対策</h4>
<ul>
<li>TLS利用時の注意点
<ul>
<li>入力画面からHTTPSにする。</li>
<li>クッキーのセキュア属性に注意。</li>
<li>画像やCSS、JSなどもHTTPSで指定する。</li>
<li>frame, iframeを使わない。使う場合はすべてのコンテンツをHTTPSにする。</li>
<li>クライアント側のブラウザのデフォルト設定でエラー表示されないようにする。
<ul>
<li>サーバの設定により、SSLを使わないようにする。TLSと違って脆弱性があるので。</li>
</ul>
</li>
<li>サーバ証明書の確認を妨げない。
<ul>
<li>アドレスバー、ステータスバーを隠さない。</li>
<li>コンテキストメニュー（右クリック）を無効化しない。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="マルウェア対策">マルウェア対策</h4>
<hr>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="https://guricerin.github.io/shit-blog/private-memo/infra-engineer-text2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">『インフラエンジニアの教科書2』の個人メモ</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-guricerin-github-io-shit-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 guricerin.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="https://guricerin.github.io/shit-blog/js/menu.js"></script>
<script src="https://guricerin.github.io/shit-blog/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>