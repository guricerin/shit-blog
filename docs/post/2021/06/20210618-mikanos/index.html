<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>『ゼロからのOS自作入門』写経した - グリのクソブログ</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="『ゼロからのOS自作入門』写経した" />
<meta property="og:description" content="通称『みかん本』。やったことはこのリポジトリのコミットタグをはじめから辿ってひたすら写経しただけ。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://guricerin.github.io/shit-blog/post/2021/06/20210618-mikanos/" />
<meta property="article:published_time" content="2021-06-18T10:03:26+09:00" />
<meta property="article:modified_time" content="2021-06-18T10:03:26+09:00" />

		<meta itemprop="name" content="『ゼロからのOS自作入門』写経した">
<meta itemprop="description" content="通称『みかん本』。やったことはこのリポジトリのコミットタグをはじめから辿ってひたすら写経しただけ。">
<meta itemprop="datePublished" content="2021-06-18T10:03:26&#43;09:00" />
<meta itemprop="dateModified" content="2021-06-18T10:03:26&#43;09:00" />
<meta itemprop="wordCount" content="156">



<meta itemprop="keywords" content="" />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="『ゼロからのOS自作入門』写経した"/>
<meta name="twitter:description" content="通称『みかん本』。やったことはこのリポジトリのコミットタグをはじめから辿ってひたすら写経しただけ。"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/style.css">
	<link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/custom.css">

	<link rel="shortcut icon" href="https://guricerin.github.io/shit-blog/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109224463-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="https://guricerin.github.io/shit-blog/" title="グリのクソブログ" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="https://guricerin.github.io/shit-blog/img/icon.jpg">
				</div><div class="logo__item logo__text">
					<div class="logo__title">グリのクソブログ</div>
					<div class="logo__tagline">主にB&#39;z</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/">
				
				<span class="menu__text">HOME</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/privacy-policy">
				
				<span class="menu__text">PRIVACY POLICY</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/feed.xml">
				
				<span class="menu__text">RSS</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">『ゼロからのOS自作入門』写経した</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2021-06-18T10:03:26&#43;09:00">2021-06-18</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="https://guricerin.github.io/shit-blog/categories/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/" rel="category">プログラミング</a>, <a class="meta__link" href="https://guricerin.github.io/shit-blog/categories/%E6%9B%B8%E7%89%A9/" rel="category">書物</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p>通称『みかん本』。やったことは<a href="https://github.com/uchan-nos/mikanos">このリポジトリ</a>のコミットタグをはじめから辿ってひたすら写経しただけ。</p>
<p>OS自作界隈を盛り上げようとしている著者には申し訳ないが、おれは別にOS自作そのものに興味があるわけではなく、コンピュータについてなにもわかっていない状況を打破したいという思いでこの本を購入した。<br>
全体像を大雑把に理解しながら学習したため、CPUなどの細かい仕様はスルー気味。<br>
以下、雑なメモ。</p>
<hr>
<h3 id="1章">1章</h3>
<p>手始めにUEFI BIOSから起動されるサンプルプログラムを作成する。バイナリエディタで機械語を直接.efiファイルに打ち込み、できあがるのはお馴染み<code>Hello, world!</code>コード。<br>
おれの場合はWSL2のUbuntu 20.04でQEMUを使用した。うまくいけば以下のように真っ黒画面に文字列が表示される。</p>
<p><img src="./1.png" alt="a"></p>
<hr>
<h3 id="2章">2章</h3>
<p>1章と同じく<code>Hello, world!</code>コードを作成するが、違いはUEFI BIOS上で動作するアプリ開発キットのEDK2を使用すること。ブートローダ作成の練習となる。<br>
ホストOS（Windows）のscoopでPythonをインストールしてたら、<code>$HOME/edk2/edksetup.sh</code>を実行した際になぜかscoopのほうのPythonパスを環境変数に設定するのでハマった記憶がある。scoopのPythonをアンインストールして環境変数を手動でリセットしてから<code>$HOME/edk2/edksetup.sh</code>を再実行することで対処した。</p>
<hr>
<h3 id="3章">3章</h3>
<p>OSのコア部分であるカーネルを作成していく。それに合わせ、作成したカーネルを起動するよう2章のブートローダを本格的に修正。<br>
<a href="https://guricerin.github.io/shit-blog/post/2021/01/20210103-nand2tetris-rust/">nand2tetrisを演習していた</a>ので、最初にでてくるアセンブリやレジスタの話題にはすんなりついていけた。ていうか、普通のCPUやレジスタってnand2tetrisのものよりずいぶん高機能だ。当然っちゃ当然か。<br>
あとは適当に画面のピクセルをいじったり。</p>
<p><img src="./3.png" alt="a"></p>
<hr>
<h3 id="4章">4章</h3>
<p>ピクセル描画の機能をピクセルフォーマットを考慮するように修正していく。メモリ上のピクセル位置を計算する部分とかピクセルの色情報を弄る部分とか、業務でOpenCVをバリバリ使っていたこともあったので若干なつかしい気分。<br>
それより、配置newってなんなんだ。やはりC++はやばい。</p>
<p><img src="./4.png" alt="a"></p>
<hr>
<h3 id="5章">5章</h3>
<p>フォントをカーネルバイナリに埋め込んだり、コンソール機能をモジュール化したり。<br>
ここまではビルド成果物をソースコードと同じディレクトリではなく専用の別ディレクトリに出力するようMakefileを改造していたが、別ディレクトリに配置されたオブジェクトファイルのシンボルをcppソースコードから読み込む方法がわからず、結局本書と同じようなMakefileに修正した。clangやld.lldのオプションでシンボル探索パスを追加すればいけそうなもんだが、コマンドオプションが大量かつ英語わからない弱者なので諦めたりした。</p>
<p><img src="./5.png" alt="a"></p>
<hr>
<h3 id="6章">6章</h3>
<p>デスクトップ画面やマウスカーソルの描画、USBドライバを使用してカーソルの制御など、見た目が一気にOSに近づいていく。USBドライバは巨大すぎるので写経すらせずディレクトリごとコピペしてしまった。<br>
IOアドレス空間を読み書きするためにとうとうアセンブリコードを書かされたりと、いよいよというところまで来ている。<br>
xHCI（USB3.0のホストコントローラ仕様）はクソむずい。全体の外観だけでも知っておくとだいぶ違うのだろうが、そこらへん調べるのはさぼった。この章あたりからいろんな規格の仕様などがバンバン出てきはじめるので、無知なほど単純に難易度が上がる。<br>
最初、マウスカーソルが動かなかったのだが、写経したつもりだったコードでカーソル描画の位置を初期値で固定したまんまというとんでもなくあほな理由で約12時間が調査のために溶けた。泣きたい。</p>
<p><img src="./6.png" alt="a"></p>
<hr>
<h3 id="7章">7章</h3>
<p>マウスカーソル描画を前章のポーリング方式（カーネルが逐一イベント通知を問い合わせる）から割り込み方式（ハードウェアがイベント通知をカーネルに投げる）に変更。<br>
筆者は章末で「退屈な章」と書いているが、個人的にはこれまでの章の中で一番おもしろかった。たぶん、おれがコンピュータの裏側で動いているアルゴリズムなんかが好きなことが原因だ。頭悪い癖にな。</p>
<hr>
<h3 id="8章">8章</h3>
<p>メモリ管理をカーネルに組み込む。mamd2tetrisでは本書のようなページング機能とかはなく、生アドレスをひたすら弄くり回していた（仮想マシンだから生アドレスもクソもねえけど）。<br>
ユーザー定義リテラルなんて文法初めて知った。しかもC++11からとっくにあるらしい。C++やばすぎる。</p>
<hr>
<h3 id="9章">9章</h3>
<p>グラフィック描画の修正。マウスカーソルの軌跡を背景色に塗りつぶしていたのを、レイヤによる重ね合わせ処理によって改善していく。前章で追加したメモリ管理機能もさっそく使って動的メモリ割当する。<br>
重ね合わせ処理によってあらたな問題（画面のちらつき）や処理速度の低下が発生するが、それらも部分描画などのよりよいアルゴリズムで修正していく。</p>
<p><img src="./9-1.gif" alt="a"></p>
<p><img src="./9-2.gif" alt="a"></p>
<hr>
<h3 id="10章">10章</h3>
<p>とうとうウィンドウを描画する。9章と同様に、描画アルゴリズムを少しずつ改善していってチラツキなどを排除する。<br>
ここにきてダブルバッファリング手法が導入される。すげー話がそれるが、MFCで画面のチラツキを抑制するのは馬鹿みたいに難しかった。それにくらべてWinFormsの簡単さときたら。<code>DoubleBuffered</code>プロパティをtrueにしたらそれで終わりなんだもの。</p>
<p><img src="./10.gif" alt="a"></p>
<hr>
<h3 id="11章">11章</h3>
<p>9章で作成したLocal APICタイマを割り込みでカウントさせるようにし、さらに複数のタイマを生成できるようにも改造する。<br>
Local APICはCPU内部の割り込みコントローラで、Local APICタイマはCPUコア1つにつき1つ搭載されている。そして名前がややこしいが、電源管理に使用されるACPI PMタイマを利用してLocal APICタイマの周期を測定する。<br>
ちなみに実装はこの章では完結しない。また、ACPI PMタイマはRSDP（Root System Descriptor Pointer）からいくつかのテーブルを経由して取得する。</p>
<hr>
<h3 id="12章">12章</h3>
<p>前半は11章のやり残し。Local APICタイマの周波数を測定し、1秒毎にタイムアウトさせるようにする。<br>
後半からはキーボード入力を割り込み制御するコードを書く。キーボードはUSB接続されていることを前提とし、マウスのときと同じくUSBドライバを使って、送信されてきたキーコードをASCii文字に変換しテキストボックスに表示する。<br>
また、実装したタイマ機能をさっそく活用し、テキストボックス内のカーソルを一定時間間隔で点滅させる機能までを実装する。<br>
現在おれが使用しているキーボードは英字配列のものだが、キーは正しく入力されている。日本語配列だとどうなるかは検証していない。</p>
<p><img src="./12.gif" alt="a"></p>
<hr>
<h3 id="13章">13章</h3>
<p>マルチタスク機能を実装する。その際、複数のコンテキスト（各タスクのレジスタなどの状況）を複数のCPUコアで同時に動かす並列処理ではなく（クソ難しいらしいので）、1つのCPUコアで複数のコンテキストを切り替えながら動かす並行処理のみで実装する。また、タスク切り替えのタイミングは割り込みで通知させる。<br>
コンテキストスイッチの実装はアセンブリで行っている。正直ほとんど理解できていないが、雑に言えば各レジスタの値をどこかのメモリアドレスにひとまとめに退避してるだけなので、コールスタックのやり方とそう変わらない印象を受けた。<br>
いまのところ、各タスクは一律のCPU時間で順番に持ち回すラウンドロビン方式（であってる？）によってスケジューリングする。</p>
<p><img src="./13.gif" alt="a"></p>
<hr>
<h3 id="14章">14章</h3>
<p>13章の続き。ラウンドロビン方式はそのままにタスクの待機列を優先度毎に階層化して、優先度の高いものがスリープしない限りより低い優先度の待機列は動かさないというスケジューリングを採用する。<br>
おもしろいけど頭パンクしそう。あとそろそろグローバルなポインタ変数がきつい。</p>
<p><img src="./14.gif" alt="a"></p>
<hr>
<h3 id="15章">15章</h3>
<p>ついにターミナルを実装していく。とはいえこの章ではまだガワを用意するに留まる。<br>
割り込み制御のコードがスパゲティ化するのを防ぐためレイヤ描画処理をメインタスクに一任するよう修正し、またアクティブウィンドウの仕組みも導入しておく。</p>
<hr>
<h3 id="16章">16章</h3>
<p>ターミナルがキー入力を受付けられるようにし、いくつかのコマンドとコマンド履歴を実装する。<br>
筆者も書いている通り、ターミナルが実現されたことで一気にOSらしさが増してテンションがぶちあがる。</p>
<p><img src="./16.gif" alt="a"></p>
<hr>
<h3 id="17章">17章</h3>
<p>ファイルシステムを導入。MikanOSではFAT32を採用する。ファイルシステムがなんもわからず、初めて聞く専門用語が非常に多い。<br>
ファイル一覧を取得する方法としては、ブロックデバイスのドライバを作成するのではなく（クソ大変らしいので）、UEFI BIOSのBlock I/O Protocolを利用しブートローダにメモリ上に展開させる。メモリにはディレクトリエントリが配列状に並んでいるため、これを処理することでlsコマンドを実装できる。</p>
<p><img src="./17.gif" alt="a"></p>
<hr>
<h3 id="18章">18章</h3>
<p>17章からの応用。ファイルの内容を読み込めるようにし、catコマンドを実装する。
また、ファイル読み込みが可能になったことで、ボリュームイメージに存在する、カーネル本体とは別のファイルをアプリとして実行可能になる。<br>
実行可能ファイルのソースコードはアセンブリでもC++コードでもいい。アプリを呼び出すカーネル側では、アプリがフラットバイナリかELF形式かでエントリーポイントのアドレス計算式を分岐させる。<br>
ここでは<a href="https://ja.wikipedia.org/wiki/%E9%80%86%E3%83%9D%E3%83%BC%E3%83%A9%E3%83%B3%E3%83%89%E8%A8%98%E6%B3%95">RPN電卓</a>アプリを作成。ただし、アプリはまだ正常には動作しない。アプリ側から見えている仮想アドレスを正しい物理アドレスに変換できているのはエントリーポイントだけだからだ。</p>
<p><img src="./18.gif" alt="a"></p>
<hr>
<h3 id="19章">19章</h3>
<p>8章で出てきたページング機能を深堀りし、仮想アドレスと物理アドレスの変換が適切になされるようにする。<br>
ここで論理アドレスと仮想アドレスの違いがわからないことに気づく。<a href="https://www.sophia-it.com/content/%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9">軽く調べた感じでは</a>同じものという認識でよさそう？<br>
途中一週間程とある同人ゲームにドンバマリしてたら内容が頭からすっ飛んだ。</p>
<p><img src="./19.gif" alt="a"></p>
<hr>
<h3 id="20章">20章</h3>
<p>アプリからOSカーネルに命令できるようにする。その際、セキュリティの観点からOSカーネルの関数そのものではなくシステムコールを使用させる。それにはセグメント記述子でCPUの実行権限レベルをアプリ用に設定したり、OSとアプリが使用するメモリ領域を分けたりする。</p>
<p>システムコールの仕組みを実装する手順は以下の通り。</p>
<ul>
<li>システムコールを作成する</li>
<li>作成したシステムコールを、システムコール専用の関数ポインタテーブルに登録</li>
<li>上記の関数ポインタテーブルからシステムコール番号を使用して所望のシステムコールを参照し実行する、という関数（システムコールエントリ）を作成</li>
<li><code>syscall</code>命令で呼び出されるよう、システムコールエントリを<code>IA32_LSTAR</code>レジスタに登録</li>
<li><code>syscall</code>、<code>sysret</code>の呼び出し前後でコンテキストの保存と復帰のために各レジスタなどをなんやかんやする。</li>
</ul>
<p>はてしなく難しい章。ここで実装するコードとかもうほとんど理解できていない。</p>
<p><img src="./20.gif" alt="a"></p>
<hr>
<h3 id="21章">21章</h3>
<p>色々なシステムコールを作成して文字列表示やアプリを終了可能にしたりする。<br>
難しい部分は20章でほぼ終わっているから楽だった。てかアセンブリにもマクロ機能ってあるんかよ。</p>
<p><img src="./21.gif" alt="a"></p>
<hr>
<h3 id="22章">22章</h3>
<p>さらにシステムコールを追加。タイマ値の取得、直線の描画、アプリ側からイベント受信、ウィンドウのクローズなどやれることが増える割にコードはかんたん（アセンブリを除く）。<br>
アプリ側はOSから送信されるイベントを、いわゆるイベントループで待機する。ポーリング方式とは違い、待機している間はOS側がアプリのタスクをスリープさせる実装なのでCPUに負荷がかかることはない。コード見てたらまたもやMFCのトラウマがぶり返した。</p>
<p><img src="./22.gif" alt="a"></p>
<hr>
<h3 id="23章">23章</h3>
<p>またまたシステムコールを追加。マウスクリック、タイマー生成、キーコードの取得などに対応することでよりインタラクティブな動きが可能となる。<br>
立方体アニメーションアプリの実装が全く理解できなくて悔しい。鼻くそほじりながら数学を楽に理解できるようになりてえ。</p>
<p><img src="./23-1.gif" alt="a"></p>
<p><img src="./23-2.gif" alt="a"></p>
<hr>
<h3 id="24章">24章</h3>
<p>複数のアプリを同時に実行できるようにするため、アプリ毎に階層ページング構造をもたせ、タスクが切り替わるたびにCPUが参照するページング構造も切り替えさせる。コードの修正量が少なくエレガントでクソびびった。<br>
それと、ターミナルを新規で立ち上げることなくアプリを実行する<code>noterm</code>コマンドを実装（実際はターミナルウィンドウを非表示にしているだけ）。<br>
また、CPU例外を起こしたアプリは強制終了させ、OSカーネル全体がパニックしないようにする。</p>
<p><img src="./24.gif" alt="a"></p>
<hr>
<h3 id="25章">25章</h3>
<p>アプリから楽にファイルにアクセスできるよう、OS側で抽象化されたファイルシステムを提供する。それにはタスク毎にファイルエントリの配列を持たせ、タスクがファイルを開く際にファイルディスクリプタという正の整数値を発行。ファイルディスクリプタはその配列へのインデックスとなる。ファイル先頭からのオフセット計算とか細かい部分はOSが担当。<br>
この章では読み込みのみに対応。ついでに正規表現コマンドも実装する。</p>
<p><img src="./25.gif" alt="a"></p>
<hr>
<h3 id="26章">26章</h3>
<p>標準入出力とアプリからのファイル書き込み機能を実装。<br>
標準入出力の仕組みは思っていた以上にシンプルで、ファイルディスクリプタ番号0, 1, 2が指定されたときにキーボードからの入力を待ち受けたりターミナルへ印字するだけだった。<br>
ファイル書き込みのコードは読み込みのものとさほど変わらない。<code>cp</code>コマンドも実装。</p>
<p><img src="./26.gif" alt="a"></p>
<hr>
<h3 id="27章">27章</h3>
<p>デマンドページング、メモリマップドファイル（ファイルマッピング）、コピーオンライトを実装。<br>
デマンドページングとは、事前に確保していたページの範囲のうち、初めてページにアクセスされたときに物理フレームを割り当てる仕組み。そうすることで、必要以上に物理メモリが確保されるのを防ぐことが可能。<br>
メモリマップドファイルはファイルの内容を仮想アドレスの連続した領域に対応付ける仕組み。これを導入することで、ファイル操作の際にストレージへの頻繁なアクセスを回避できる（MikanOSではカーネル起動の際にファイルをメモリ上にすべて展開するので恩恵を感じにくいが）。<br>
コピーオンライトは、例えば同じアプリを複数のタスクで実行する場合、そのアプリのデータが読み込まれたメモリをタスク間で共有させ、グローバル変数などを書き換える際に該当部分だけ別のメモリ領域にコピーさせる仕組み。<br>
上記の3つとも、<a href="https://gihyo.jp/book/2018/978-4-7741-9607-7">試して理解 Linuxのしくみ</a>にて解説されていたのをいまさら思い出した。たしか去年の頭に読んだわ。もう全然覚えてねー。<br>
割り込み、階層ページング構造、ファイルシステムなど今までに実装してきた技術の応用かつコードも複雑なので、超むずい。</p>
<p><img src="./27.gif" alt="a"></p>
<hr>
<h3 id="28章">28章</h3>
<p>UnicodeのUTF-8を採用して日本語表示できるようにする。実は文字コードの仕組みとかASCII以外よくわかっていないザコだったが、まさか本書である程度学習できるとは思わなかった。いや予想できてしかるべきか。本書の一番最初のサンプル画像に思い切り日本語表示されてたし。<br>
後半では標準出力をターミナル以外に接続するリダイレクト機能を実装する（標準入力のほうは実装しない）。コマンドに<code>&gt;</code>が含まれていたら出力先を指定ファイルに切り替えるだけなので、すげえ簡単。</p>
<p><img src="./28.gif" alt="a"></p>
<hr>
<h3 id="29章">29章</h3>
<p>パイプによるアプリ間通信を実装。<code>|</code>の前後で別々のコマンドを並べることにより、あるアプリの標準出力を別のアプリの標準入力に繋げることができるようになる。<br>
<code>|</code>右側のコマンド用にもう一つ別のタスクを起動させ、2つのタスクを並行で実行させる。もちろん、それぞれの標準入出力はパイプ用に切替えておく。データの送信・受信には割り込みを利用する。アセンブリは書かされないが、マルチタスクの本領発揮って感じで難しい。<br>
実装はしないが、共有メモリの解説もなされる。仕組み自体はコピーオンライトと似ており、物理フレームを仮想ページに書き込み許可でマップすることで、複数のタスク間でデータを共有可能となるそうな。<br>
また話がそれるが、MFCで作られた複数のアプリケーションを連携して動作させる、というプロジェクトに共有メモリがやたらと登場していたのを思い出した。周期的に共有メモリを読み書きしなきゃいけないわデータ競合発生するわで、当時は脳みそがしぼむような錯覚に襲われた。</p>
<p><img src="./29.gif" alt="a"></p>
<hr>
<h3 id="30章">30章</h3>
<p>おまけのような章。テキストビューワーと画像ビューワーを作る。見た目がずいぶんリッチになる。</p>
<p><img src="./30.gif" alt="a"></p>
<hr>
<h3 id="まとめ">まとめ</h3>
<p>nand2tetrisで雑に扱われていたOS解説の部分を補完してくれる書籍。主に以下の事項の詳細を新たに学ぶことができた。</p>
<ul>
<li>割り込み</li>
<li>グラフィック描画の応用（レイヤ、部分的描画、ダブルバッファリングなど）</li>
<li>マルチタスク</li>
<li>ファイルシステム（FAT32、ファイルディスクリプタ、標準入出力など）</li>
<li>階層ページング構造</li>
<li>カーネルからのアプリケーション呼び出し</li>
<li>システムコール</li>
<li>デマンドページング</li>
<li>メモリマップドファイル</li>
<li>コピーオンライト</li>
<li>Unicode</li>
<li>アプリ間通信</li>
</ul>
<p>本書に対する文句ではないが、CPUがnand2tetrisのものと比べて高機能な分それを制御するためのコードもより複雑になっており、とくにコンテキストの復元などで各レジスタ値の保存・復帰する処理や、スタックをOS・アプリ間で切替えたりする部分なんかは頭が破裂する。nand2tetrisのアセンブリの世界はすごく牧歌的だったんだなと今にして思う。あちらはシングルタスクっていうのもでかい。<br>
てかレジスタ名が分かりづらすぎやしねえか。引数を格納するレジスタとか連番でよかったんちゃうんかと。まあここらへんはたぶん、歴史的事情ってやつなんだろう。</p>
<hr>
<h3 id="でコンピュータについての理解が少しは深まりましたか">で、コンピュータについての理解が少しは深まりましたか？</h3>
<p>それどころか学べば学ぶほど自分がカスだという事実に向き合わざるをえないんすが。</p>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="https://guricerin.github.io/shit-blog/post/2021/01/20210103-nand2tetris-rust/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Rustで『コンピュータシステムの理論と実装』を演習した</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="https://guricerin.github.io/shit-blog/post/2021/06/20210626-linux-tcpip/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">『Linuxで動かしながら学ぶTCP/IPネットワーク入門』読んだ</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-guricerin-github-io-shit-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 guricerin.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="https://guricerin.github.io/shit-blog/js/menu.js"></script>
<script src="https://guricerin.github.io/shit-blog/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>