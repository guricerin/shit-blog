<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』読んだ - グリのクソブログ</title>
  <script>(function (d, e) { d[e] = d[e].replace("no-js", "js"); })(document.documentElement, "className");</script>
  <meta name="description"
    content="">
  <meta property="og:title" content="『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』読んだ" />
<meta property="og:description" content="セキュリティなんも知らんので購入。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://guricerin.github.io/shit-blog/post/2021/12/05-wasbook/" />
<meta property="article:published_time" content="2021-12-05T16:10:50+09:00" />
<meta property="article:modified_time" content="2021-12-05T16:10:50+09:00" />

  <meta itemprop="name" content="『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』読んだ">
<meta itemprop="description" content="セキュリティなんも知らんので購入。">
<meta itemprop="datePublished" content="2021-12-05T16:10:50&#43;09:00" />
<meta itemprop="dateModified" content="2021-12-05T16:10:50&#43;09:00" />
<meta itemprop="wordCount" content="491">



<meta itemprop="keywords" content="" />
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』読んだ"/>
<meta name="twitter:description" content="セキュリティなんも知らんので購入。"/>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700" >

  <link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/style.css">
  <link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/custom.css">

  <link rel="shortcut icon" href="https://guricerin.github.io/shit-blog/%20favicon.ico">
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109224463-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <link rel="stylesheet" href="https://guricerin.github.io/shit-blog/css/share.css">
</head>

<body class="body">
  <div class="container container--outer">
    <header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="https://guricerin.github.io/shit-blog/" title="グリのクソブログ" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="https://guricerin.github.io/shit-blog/img/icon.jpg">
				</div><div class="logo__item logo__text">
					<div class="logo__title">グリのクソブログ</div>
					<div class="logo__tagline">主にB&#39;z</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/">
				
				<span class="menu__text">HOME</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/privacy-policy">
				
				<span class="menu__text">PRIVACY POLICY</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="https://guricerin.github.io/shit-blog/feed.xml">
				
				<span class="menu__text">RSS</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
    <div class="wrapper flex">
      <div class="primary">
        
<main class="main" role="main">
    <article class="post">
        <header class="post__header">
            <h1 class="post__title">『体系的に学ぶ 安全なWebアプリケーションの作り方 第2版』読んだ</h1>
            <div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2021-12-05T16:10:50&#43;09:00">2021-12-05</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="https://guricerin.github.io/shit-blog/categories/%E6%9B%B8%E7%89%A9/" rel="category">書物</a>, <a class="meta__link" href="https://guricerin.github.io/shit-blog/categories/%E6%83%85%E5%A0%B1%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/" rel="category">情報セキュリティ</a>
	</span>
</div></div>
        </header>
        
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#環境">環境</a></li>
    <li><a href="#2章-実習環境のセットアップ">2章 実習環境のセットアップ</a>
      <ul>
        <li><a href="#us配列キーボードを使用している場合の設定">US配列キーボードを使用している場合の設定</a></li>
        <li><a href="#owasp-zap-v280をインストールした場合の追加設定">OWASP ZAP v2.8.0をインストールした場合の追加設定</a></li>
      </ul>
    </li>
    <li><a href="#3章-webセキュリティの基礎">3章 Webセキュリティの基礎</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#4章-webアプリケーションの機能別に見るセキュリティバグ">4章 Webアプリケーションの機能別に見るセキュリティバグ</a>
      <ul>
        <li><a href="#ssh接続">ssh接続</a></li>
        <li><a href="#webアプリケーションの機能と脆弱性の対応">Webアプリケーションの機能と脆弱性の対応</a></li>
        <li><a href="#入力処理とセキュリティ">入力処理とセキュリティ</a></li>
        <li><a href="#表示処理に伴う問題">表示処理に伴う問題</a></li>
        <li><a href="#sql呼び出しに伴う脆弱性">SQL呼び出しに伴う脆弱性</a></li>
        <li><a href="#重要な処理の際に混入する脆弱性">「重要な処理」の際に混入する脆弱性</a></li>
        <li><a href="#セッション管理の不備">セッション管理の不備</a></li>
        <li><a href="#リダイレクト処理にまつわる脆弱性">リダイレクト処理にまつわる脆弱性</a></li>
        <li><a href="#クッキー出力にまつわる脆弱性">クッキー出力にまつわる脆弱性</a></li>
        <li><a href="#メール送信の問題">メール送信の問題</a></li>
        <li><a href="#ファイルアクセスにまつわる問題">ファイルアクセスにまつわる問題</a></li>
        <li><a href="#osコマンド呼び出しの際に発生する脆弱性">OSコマンド呼び出しの際に発生する脆弱性</a></li>
        <li><a href="#ファイルアップロードにまつわる問題">ファイルアップロードにまつわる問題</a></li>
        <li><a href="#インクルードにまつわる問題">インクルードにまつわる問題</a></li>
        <li><a href="#構造化データの読み込みにまつわる問題">構造化データの読み込みにまつわる問題</a></li>
        <li><a href="#共有資源やキャッシュに関する問題">共有資源やキャッシュに関する問題</a></li>
        <li><a href="#web-api実装における脆弱性">Web API実装における脆弱性</a></li>
        <li><a href="#javascriptの問題">JavaScriptの問題</a></li>
      </ul>
    </li>
    <li><a href="#5章-代表的なセキュリティ機能">5章 代表的なセキュリティ機能</a></li>
    <li><a href="#6章-文字コードとセキュリティ">6章 文字コードとセキュリティ</a></li>
    <li><a href="#7章-脆弱性診断入門">7章 脆弱性診断入門</a></li>
    <li><a href="#8章-webサイトの安全性を高めるために">8章 Webサイトの安全性を高めるために</a></li>
    <li><a href="#9章-安全なwebアプリケーションのための開発マネジメント">9章 安全なWebアプリケーションのための開発マネジメント</a></li>
    <li><a href="#雑な感想">雑な感想</a></li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
            <p>セキュリティなんも知らんので購入。</p>
<p>サポートサイト : <a href="https://wasbook.org/">https://wasbook.org/</a></p>
<p>Webアプリに対する代表的なセキュリティ攻撃とその対策を網羅する書籍。攻撃と防御の実演には、ローカルネットワークで繋げた仮想環境を用いる。</p>
<hr>
<h2 id="環境">環境</h2>
<ul>
<li>Windows 11 Pro
<ul>
<li>バージョン : 21H2</li>
<li>ビルド : 22000.318</li>
<li>CPU : AMD Ryzen 7 3700X 8-Core Processor</li>
<li>Hyper-V : 有効にしたまま</li>
</ul>
</li>
<li>VirtualBox : バージョン 6.1.30 r148432 (Qt5.6.2)</li>
<li>OWASP ZAP : バージョン 2.11</li>
<li>JRE : バージョン 1.8.0_311</li>
<li>FireFox : バージョン 94.0.2</li>
</ul>
<hr>
<h2 id="2章-実習環境のセットアップ">2章 実習環境のセットアップ</h2>
<h3 id="us配列キーボードを使用している場合の設定">US配列キーボードを使用している場合の設定</h3>
<p>仮想OS（wasbook）がこちらのキーボードを日本語配列として認識しているっぽいので、設定を変更する。</p>
<p>現在のロケール設定を確認。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ localectl
  System Locale: LANG<span style="color:#f92672">=</span>en_US.UTF-8
                 LANGUAGE<span style="color:#f92672">=</span>en_US:en
    VC Keymap: n/a
    X11 Layout: jp
    X11 Model: pc101
</code></pre></div><p>キーマップをUS配列に変更。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># /etc/default/keyboard</span>
XKBLAYOUT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us&#34;</span>
</code></pre></div><p>設定のリロード。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo service keyboard-setup restart
</code></pre></div><p>再度<code>localectl</code>を実行して<code>X11 Lauout</code>が<code>us</code>になってたらOK。</p>
<h5 id="参考リンク">参考リンク</h5>
<ul>
<li><a href="https://wiki.archlinux.jp/index.php/%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A">https://wiki.archlinux.jp/index.php/%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A</a></li>
<li><a href="https://wiki.debian.org/Keyboard">https://wiki.debian.org/Keyboard</a></li>
</ul>
<hr>
<h3 id="owasp-zap-v280をインストールした場合の追加設定">OWASP ZAP v2.8.0をインストールした場合の追加設定</h3>
<p>v2.11.0にも同様の機能があるので、それを無効化するため本書と同じように設定した。</p>
<hr>
<h2 id="3章-webセキュリティの基礎">3章 Webセキュリティの基礎</h2>
<p>HTTPの基礎（の一部）とセッション管理の原理、クロスオリジンアクセスについて解説がなされる。</p>
<ul>
<li>HTTPの基礎を全体的に学習するには、本書でも参照されてる『Webを支える技術』がおすすめ。</li>
<li>クッキーの説明でひっかかったけど、「名前=変数」ではなくて「変数=値」（または「識別子=値」）が正しいんじゃないか？</li>
<li>P.87について、最初、本書通りの結果にならなかったが、スキームを<code>http</code>にしたら上手くいった。</li>
</ul>
<h5 id="httpsの場合">httpsの場合</h5>
<p><img src="./2.png" alt="a"></p>
<h5 id="httpの場合">httpの場合</h5>
<p><img src="./1.png" alt="a"></p>
<hr>
<h2 id="4章-webアプリケーションの機能別に見るセキュリティバグ">4章 Webアプリケーションの機能別に見るセキュリティバグ</h2>
<h3 id="ssh接続">ssh接続</h3>
<p>このあたりでVirtualBoxの小さくて汚い画面がだるなってきたので、ホストOSのターミナルからゲストOSの中身を見れるようssh接続設定することにした。</p>
<p>まずゲストでsshが稼働しているか<code>sudo lsof -i:22</code>で確認。</p>
<p><img src="./3.png" alt="a"></p>
<p>sshデーモンがばっちり待機していた。ついでに<code>systemctl list-units | grep ssh</code>でなんのsshデーモンが動いているかも調べている。</p>
<p>次に<code>ip a</code>でIPアドレスを調べる。</p>
<p><img src="./4.png" alt="a"></p>
<p>本書のとおりに設定していれば、番号が若い順に<code>enp0s3</code>はゲストOSがインターネット接続するための<code>NAT</code>、<code>eth0s8</code>はホストOSがゲストOSに接続するための<code>ホストオンリーアダプター</code>なので、sshコマンドで<code>ホストオンリーアダプター</code>のアドレス<code>192.168.56.101</code>を指定すれば繋がるはず。繋がった。</p>
<p><img src="./5.png" alt="a"></p>
<p>さて、ついでなので公開鍵方式でssh接続するよう設定する。<br>
ホストOS側で公開鍵・秘密鍵を生成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ssh-keygen -t ecdsa
Generating public/private ecdsa key pair.
Enter file in which to save the key <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\g</span>uriz/.ssh/id_ecdsa<span style="color:#f92672">)</span>:
Enter passphrase <span style="color:#f92672">(</span>empty <span style="color:#66d9ef">for</span> no passphrase<span style="color:#f92672">)</span>:
Enter same passphrase again:
Your identification has been saved in C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\g</span>uriz/.ssh/id_ecdsa.
Your public key has been saved in C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\g</span>uriz/.ssh/id_ecdsa.pub.
The key fingerprint is:
SHA256:&lt;hoge&gt; guriz@alpha
The key<span style="color:#960050;background-color:#1e0010">&#39;</span>s randomart image is:
（省略）
</code></pre></div><p>ゲストOSに公開鍵をコピー。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd $HOME/.ssh
$ scp id_ecdsa.pub wasbook@192.168.56.101:.ssh/
wasbook@192.168.56.101<span style="color:#960050;background-color:#1e0010">&#39;</span>s password:
id_ecdsa.pub                                                                          100%  <span style="color:#ae81ff">174</span>    87.1KB/s   00:00
</code></pre></div><p>ゲストOSでホストOSの公開鍵を登録。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd $HOME/.ssh
$ cat id_ecdsa.pub &gt;&gt; authorized_keys
</code></pre></div><p>公開鍵認証に切り替えるため、<code>sshd_config</code>を以下のように書き換える。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># /etc/ssh/sshd_config</span>
PubkeyAuthentication yes
PasswordAuthntication no
</code></pre></div><p>設定ファイルを書き換えたので、sshdを再起動。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl restart sshd
</code></pre></div><p>再度、ホストOSからssh接続してみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd $HOME/.ssh
$ ssh wasbook@192.168.56.101 -i id_ecdsa
Linux wasbook 4.9.0-4-686 <span style="color:#75715e">#1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) i686</span>

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms <span style="color:#66d9ef">for</span> each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Nov <span style="color:#ae81ff">24</span> 21:30:39 <span style="color:#ae81ff">2021</span> from 192.168.56.1
wasbook@wasbook:~$
</code></pre></div><p>これでOK。あとは毎回秘密鍵を指定するのが面倒なら、<code>.ssh/config</code>に接続先を書き加えればよい。</p>
<h5 id="参考リンク-1">参考リンク</h5>
<ul>
<li><a href="https://guricerin.github.io/shit-blog/post/2020/09/20200914-windows-to-wsl2-ssh/">WindowsのpwshからsshでWSL2に接続</a></li>
</ul>
<h3 id="webアプリケーションの機能と脆弱性の対応">Webアプリケーションの機能と脆弱性の対応</h3>
<ul>
<li>P.98の図について、最初は「入力に起因する脆弱性はない」などの文章の意味がわからなかった。「不正なHTTPリクエストの入力が起因となるからセキュリティが脅かされるのでは？」と。</li>
<li>が、「HTTPリクエストがWebアプリに入力され、そこで処理されて出力されたデータがまた別のシステムへの入力となる」という見立ての元なら、まあわかる。Webアプリの処理部分がタコならHTTPリクエストが不正じゃなくてもセキュリティにとっては深刻なままということ。</li>
</ul>
<h3 id="入力処理とセキュリティ">入力処理とセキュリティ</h3>
<p>入力処理として、以下の検証を行うべしという話。</p>
<ul>
<li>文字エンコーディングが妥当か。</li>
<li>必要なら文字エンコーディングを変換する。</li>
<li>入力されたパラメータ文字列が妥当か。</li>
</ul>
<p>PHPの仕様や文字列バリデーションは大変だなあと思った。</p>
<h3 id="表示処理に伴う問題">表示処理に伴う問題</h3>
<p>表示処理が原因で発生する問題は以下。</p>
<ul>
<li>XSS（クロスサイト・スクリプティング）
<ul>
<li>メタ文字のエスケープ漏れにより、任意のHTMLやJSが注入される。</li>
</ul>
</li>
<li>エラーメッセージからの情報漏洩
<ul>
<li>エラーの詳細は画面じゃなくてログに吐け。</li>
</ul>
</li>
</ul>
<p>JSってやりたい放題できすぎるなあって思った。</p>
<h3 id="sql呼び出しに伴う脆弱性">SQL呼び出しに伴う脆弱性</h3>
<ul>
<li>SQLインジェクション
<ul>
<li>文字列リテラル・数値リテラルの特性を突いて、任意のSQL文が注入される。</li>
<li>静的プレースホルダ（プリペアド・ステートメント）使え。</li>
<li>エラーメッセージを画面に出すな。</li>
</ul>
</li>
</ul>
<p>SQLの文法まだまだ全然知らないなあって思った。</p>
<h3 id="重要な処理の際に混入する脆弱性">「重要な処理」の際に混入する脆弱性</h3>
<p>ユーザ本人からのリクエストであることを確認する処理が抜けることによる脆弱性は以下。</p>
<ul>
<li>CSRF（クロスサイト・リクエストフォージェリ）
<ul>
<li>攻撃対象サイトにログインしているユーザが罠を踏んで攻撃リクエストが送信され、そのユーザの権限で勝手に処理が実行される。</li>
<li>一時的なトークンを埋め込め。</li>
<li>重要な処理の実行後はユーザに通知メールを送信しろ。</li>
</ul>
</li>
<li>クリックジャッキング
<ul>
<li>罠サイトの透明なiframe要素内から、攻撃対象ページを参照される。</li>
<li><code>X-Frame-Options</code>レスポンスヘッダを設定しろ。</li>
</ul>
</li>
</ul>
<p>罠サイトは怖いなあって思った。</p>
<h3 id="セッション管理の不備">セッション管理の不備</h3>
<p>攻撃者にセッションIDを悪用される手法は以下。</p>
<ul>
<li>セッションIDの推測
<ul>
<li>Webアプリフレームワークのセッション管理機構を使え。</li>
</ul>
</li>
<li>セッションIDの盗み出し
<ul>
<li>クッキー以外にセッションIDを保存するな。</li>
</ul>
</li>
<li>セッションIDの強制
<ul>
<li>認証後にセッションIDを変更しろ。</li>
</ul>
</li>
</ul>
<p>「クッキー有害論」なんてものがあったんだなあと思った。</p>
<h3 id="リダイレクト処理にまつわる脆弱性">リダイレクト処理にまつわる脆弱性</h3>
<ul>
<li>オープンリダイレクト
<ul>
<li>パラメータで指定した任意のドメインにリダイレクト可能な脆弱性。</li>
<li>リダイレクト先は固定にしろ。</li>
<li>先にクッションページに遷移させろ。</li>
</ul>
</li>
<li>HTTPヘッダ・インジェクション
<ul>
<li>改行文字を挿入したパラメータを参照させることで、任意のHTTPレスポンスが作成可能な脆弱性。</li>
<li>外部パラメータからHTTPレスポンスヘッダを作るな。</li>
<li>どうしても作りたけりゃ改行文字が入ってないかチェックしろ。</li>
</ul>
</li>
</ul>
<p>気軽にリンクを踏むのは怖いなあと思った。</p>
<h3 id="クッキー出力にまつわる脆弱性">クッキー出力にまつわる脆弱性</h3>
<ul>
<li>クッキーにセキュア属性が付与されていない
<ul>
<li>HTTPS通信であってもクッキー値を盗聴される。</li>
<li>セキュア属性をつけろ。</li>
</ul>
</li>
</ul>
<p>とりあえずHTTPS通信させてセキュア属性つけときゃいいんだなあと思った。</p>
<h3 id="メール送信の問題">メール送信の問題</h3>
<ul>
<li>メールヘッダ・インジェクション
<ul>
<li>メールの宛先や件名などヘッダフィールドに改行を挿入することで、新たなフィールドを追加したり本文を改竄する攻撃。</li>
<li>外部パラメータを使うな。</li>
<li>改行をチェックしろ。</li>
</ul>
</li>
<li>hiddenパラメータによる宛先保持
<ul>
<li>hiddenパラメータを任意のアドレスに改竄され、迷惑メール送信に悪用される。</li>
<li>送信先メアドなどはサーバ上のファイルやDBなどに保管しろ。</li>
</ul>
</li>
<li>メールサーバによる第三者中継
<ul>
<li>サーバ設定に問題があると第三者のメールを中継する。</li>
</ul>
</li>
</ul>
<p>ガラケー時代は迷惑メールだらけだったなあと思った。</p>
<h3 id="ファイルアクセスにまつわる問題">ファイルアクセスにまつわる問題</h3>
<ul>
<li>ディレクトリ・トラバーサル
<ul>
<li>外部パラメータから、アプリ側が意図しないサーバ上のファイルにアクセスされる。</li>
<li>外部パラメータにディレクトリ名が含まれないようにしろ。</li>
</ul>
</li>
<li>意図しないファイル公開
<ul>
<li>Webサーバの公開ディレクトリに非公開（のつもりの）ファイルを配置しているとアクセス可能となる。</li>
<li>配置するな。</li>
<li>ディレクトリ・リスティングを無効にしろ。</li>
</ul>
</li>
</ul>
<p>ファイルをぶっこ抜かれるのは怖いなあと思った。</p>
<h3 id="osコマンド呼び出しの際に発生する脆弱性">OSコマンド呼び出しの際に発生する脆弱性</h3>
<ul>
<li>OSコマンド・インジェクション
<ul>
<li>外部パラメータから任意のOSコマンドを実行され、やりたい放題される。</li>
<li>シェル呼び出し関数を使うな。</li>
<li>使うなら外部パラメータを参照するな。せめてシェルのメタ文字をエスケープしろ。</li>
</ul>
</li>
</ul>
<p><code>Webshell</code>めっちゃ怖いなあと思った。</p>
<h3 id="ファイルアップロードにまつわる問題">ファイルアップロードにまつわる問題</h3>
<ul>
<li>アップロードファイルによるサーバ側スクリプト実行
<ul>
<li>OSコマンド・インジェクションと同じような攻撃。</li>
<li>ユーザがアップロードしたファイルは公開ディレクトリに配置せず、スクリプト経由で閲覧させろ。</li>
<li>ファイルの拡張子を制限しろ。</li>
</ul>
</li>
<li>ファイルダウンロードによるXSS
<ul>
<li>HTMLやJSスクリプトを仕込んだ画像ファイルやPDFファイルをアップロードして公開、ユーザのブラウザにこれらをHTMLとして認識させ、XSS攻撃を成立させる。</li>
<li>ファイルの<code>Content-Type</code>を正しく設定しろ。</li>
<li>レスポンスヘッダ<code>X-Content-Type-Options: nosniff</code>を指定しろ。</li>
</ul>
</li>
</ul>
<p>ドキュメントルートの設定はちゃんとせななあと思った。</p>
<h3 id="インクルードにまつわる問題">インクルードにまつわる問題</h3>
<ul>
<li>ファイルインクルード攻撃
<ul>
<li>インクルードするファイル名を外部から指定可能な場合に、アプリが意図しないファイルを指定することで攻撃する。</li>
<li>インクルードするパス名に外部パラメータを含めるな。</li>
<li>含めるなら英数字限定にしろ。</li>
</ul>
</li>
</ul>
<p>PHPってザルすぎねえかなあって思った。</p>
<h3 id="構造化データの読み込みにまつわる問題">構造化データの読み込みにまつわる問題</h3>
<ul>
<li>evalインジェクション
<ul>
<li>文字列をコードとして解釈・実行する機能を利用して外部から送信したスクリプトを実行する攻撃。</li>
<li><code>eval</code>を使うな。</li>
</ul>
</li>
<li>安全でないデシリアライゼーション
<ul>
<li>デシリアライズの際に意図しないオブジェクトがアプリ内に生成され、場合によっては任意コードを実行される。</li>
<li>シリアライズ形式ではなくJSON形式でデータを渡せ。</li>
</ul>
</li>
<li>XML外部実体参照（XXE）
<ul>
<li>XMLデータを外部から受け取るプログラムは、外部実体参照の形でWebサーバ内部のファイルなどを不正に読み取られる。</li>
<li>外部からのデータ受け取りにXMLではなくJSONを使え。</li>
</ul>
</li>
</ul>
<p>JSONって便利だなあと思った。</p>
<h3 id="共有資源やキャッシュに関する問題">共有資源やキャッシュに関する問題</h3>
<ul>
<li>競合状態の脆弱性
<ul>
<li>共有資源が不適切に利用され、別人の個人情報などを表示してしまう。</li>
<li>共有資源を避けろ。</li>
<li>排他制御しっかりやれ。</li>
</ul>
</li>
<li>キャッシュからの情報漏洩
<ul>
<li>キャッシュを過剰に利用していると、別人の個人情報を表示してしまう。</li>
<li>レスポンスヘッダでキャッシュを抑制しろ。</li>
<li>キャッシュサーバ側でキャッシュ抑制のレスポンスヘッダを無視しないようにしろ。</li>
</ul>
</li>
</ul>
<p>リバースプロキシとかロードバランサーとか理解できてねえなあと思った。</p>
<h3 id="web-api実装における脆弱性">Web API実装における脆弱性</h3>
<p>JSONデータを返すようなWeb APIサーバにおける脆弱性は以下。</p>
<ul>
<li>JSONエスケープの不備
<ul>
<li>意図しないJSがJSONに混入し、不正実行される。</li>
<li>ライブラリ関数でエスケープしろ。</li>
<li>JSONPをやめてCORSに移行しろ。</li>
</ul>
</li>
<li>JSON直接閲覧によるXSS
<ul>
<li>APIが返すレスポンスデータをブラウザで直接閲覧させることで攻撃する。</li>
<li>MIMEタイプをちゃんと<code>application/json</code>にしろ。</li>
<li>レスポンスヘッダ<code>X-Content-Type-Options: nosniff</code>を出力しろ。</li>
</ul>
</li>
<li>JSONPのコールバック関数によるXSS
<ul>
<li>MIMEタイプをちゃんと<code>text/javascript</code>にしろ。</li>
<li>コールバック関数名を検証しろ。</li>
</ul>
</li>
<li>Web APIのCSRF
<ul>
<li>CSRF対策用のトークンをJSONで返せ。</li>
</ul>
</li>
<li>JSONハイジャック
<ul>
<li>ユーザの秘密情報をJSONで返している場合に、その情報をパクる攻撃。</li>
<li><code>X-Content-Type-Options: nosniff</code>レスポンスヘッダを出力しろ。</li>
</ul>
</li>
<li>JSONPの不適切な利用
<ul>
<li>JSONPを使うな。</li>
</ul>
</li>
<li>CORSの検証不備
<ul>
<li><code>Access-Control-Allow-Origin</code>にオリジンとしてなんでも許可する<code>*</code>を指定しちまってる。</li>
<li><code>Origin</code>リクエストヘッダをちゃんと検証しろ。</li>
<li><code>Access-Control-Allow-Origin</code>レスポンスヘッダをちゃんと明示しろ。</li>
</ul>
</li>
</ul>
<p>なんやかんやJSONも脆弱性あるなあって思った。</p>
<h3 id="javascriptの問題">JavaScriptの問題</h3>
<p>クライアントサイドでやらかしてしまう脆弱性。</p>
<ul>
<li>DOM Based XSS
<ul>
<li>JSでDOM操作をする箇所に発生するXSS脆弱性。</li>
<li>URLを検証しろ。</li>
<li>HTMLのメタ文字をエスケープしろ。</li>
</ul>
</li>
<li>Webストレージの不適切な使用
<ul>
<li>JSでアクセス可能な、ブラウザのストレージを狙った攻撃。</li>
<li>Webストレージに秘密情報を保存するな。</li>
</ul>
</li>
<li>postMessageの呼び出しの不備
<ul>
<li>複数のウィンドウが異なるオリジンで動作する環境で、攻撃者が用意したURLにデータを送信してしまう。</li>
<li>メッセージの送信元・送信先をちゃんと検証しろ。</li>
</ul>
</li>
<li>オープンリダイレクト
<ul>
<li>リダイレクト先URLを動的に生成している場合に突かれる脆弱性。</li>
<li>リダイレクト先のURLを固定しろ。</li>
</ul>
</li>
</ul>
<p>postMessageはなんだかWin32 APIを彷彿させるなあと思った。</p>
<hr>
<h2 id="5章-代表的なセキュリティ機能">5章 代表的なセキュリティ機能</h2>
<p>認証、アカウント管理、認可、ログ出力について注意すべき事柄や実装方法を解説。具体的には「パスワードはハッシュ関数にぶちこんでからDBに保存しろ」など。<br>
一番ためになったのはログ出力の項目。今まで作ってきたアプリでは関数名とかを適当に出力していたが、「出力項目は4W1Hを意識しろ」などの指摘がガツンときた。</p>
<hr>
<h2 id="6章-文字コードとセキュリティ">6章 文字コードとセキュリティ</h2>
<p>とりあえずUTF-8にしとけみたいな。<br>
文字エンコーディングがきちんと設定されているかの確認方法である「尾骶骨」テストと「つちよし」テストの話が面白い。</p>
<hr>
<h2 id="7章-脆弱性診断入門">7章 脆弱性診断入門</h2>
<p>OpenVASによる自動脆弱性診断、OWASP ZAPによる自動・手動脆弱性診断、RIPSによるソースコード診断を体験する。</p>
<ul>
<li>環境
<ul>
<li>Nmap : ver 7.92</li>
</ul>
</li>
<li>OpenVASの脆弱性診断には約20分かかった。最初、プログレスバーが1%あたりから全然動かないから焦った。</li>
<li>OWASP ZAPの動的スキャンは約5分。</li>
<li>OWASP ZAPがスキャンした脆弱性情報をエキスポートできるらしいので、試しにmarkdown形式でエキスポートしてみたら文字化けが多すぎた。使うのならオール英語のほうがいいかも。</li>
<li>データが破壊される危険性があるので、本番環境で脆弱性診断はやってはいけない。</li>
<li>RIPSのソースコード診断は一瞬で終わった。</li>
</ul>
<hr>
<h2 id="8章-webサイトの安全性を高めるために">8章 Webサイトの安全性を高めるために</h2>
<p>Webアプリではなく、サーバデーモンやネットワーク機器などミドルウェア側における脆弱性とその対策について。</p>
<ul>
<li>Webサーバに不要なソフトウェアは稼働させるな。</li>
<li>一般公開する必要のないポートやサービスはアクセス制限しろ。</li>
<li>TelnetデーモンとFTPデーモンは停止しろ。</li>
<li>sshデーモンではパスワード認証をやめて公開鍵認証にしろ。</li>
<li>クラウドサービスの管理者アカウントは担当者毎に割り当て、可能なら二段階認証を設定しろ。</li>
<li>同一セグメント内に脆弱なサーバを置くな。</li>
<li>すべてのコンテンツをHTTPSで通信させろ。</li>
<li>SSLは脆弱性があるのでTLSを使え。</li>
<li>出所の不明なプログラムをサーバに入れるな。</li>
<li>運営に直接関係のない操作（Webやメールの閲覧など）はするな。</li>
<li>USBメモリなど外部メディアを装着するな。</li>
<li>Webサーバのネットワークを執務スペースのLANと切り離せ。</li>
<li>サーバに接続するクライアントPCにウィルス対策ソフトを導入してパターンファイルを最新に保て。</li>
</ul>
<hr>
<h2 id="9章-安全なwebアプリケーションのための開発マネジメント">9章 安全なWebアプリケーションのための開発マネジメント</h2>
<p>めっちゃ斜め読みした。</p>
<hr>
<h2 id="雑な感想">雑な感想</h2>
<ul>
<li>PHPの事情に依存している内容が多い。まあなにかしら特定の言語で記述されているほうがいいっちゃいいが、おれのような頭の悪い人間には動的型付け言語は鬼門である。
<ul>
<li>「mb_eregは戻り値として整数型か論理型を返す」、「filter_inputは文字列型か論理型かnullを返す」。正気の沙汰じゃねえ。やはり代数的データ型は正義。</li>
</ul>
</li>
<li>個々の用語やツールの使い方などの説明は非常に丁寧。詰まることはほぼないと思われる。</li>
<li>攻撃手法を考えつくやつはすごく頭が良い。使うだけのやつはただのクズ。</li>
<li>セキュリティ面だけでも考慮すべきことが多すぎて、フレームワーク使わな絶対に何かが漏れるな。</li>
<li>本書は開発者向けの書物だけど、ユーザ向けで定番のやつってあるんだろうか。親とかに読ませたいんやが。</li>
</ul>
        </div>
    </article>
</main>

<br/>
<div class="sns-share">
    <ul>
        <li>
            <a class="sns-share-btn sns-share-btn-fb"
                href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fguricerin.github.io%2fshit-blog%2fpost%2f2021%2f12%2f05-wasbook%2f&t=%e3%80%8e%e4%bd%93%e7%b3%bb%e7%9a%84%e3%81%ab%e5%ad%a6%e3%81%b6%20%e5%ae%89%e5%85%a8%e3%81%aaWeb%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e4%bd%9c%e3%82%8a%e6%96%b9%20%e7%ac%ac2%e7%89%88%e3%80%8f%e8%aa%ad%e3%82%93%e3%81%a0 - グリのクソブログ" target="_blank"
                title="Facebook" rel="nofollow"><i class="fab fa-facebook-f"></i></a>
        </li>
        <li>
            <a class="sns-share-btn sns-share-btn-tw"
                href="https://twitter.com/intent/tweet?url=https%3a%2f%2fguricerin.github.io%2fshit-blog%2fpost%2f2021%2f12%2f05-wasbook%2f&text=%e3%80%8e%e4%bd%93%e7%b3%bb%e7%9a%84%e3%81%ab%e5%ad%a6%e3%81%b6%20%e5%ae%89%e5%85%a8%e3%81%aaWeb%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e4%bd%9c%e3%82%8a%e6%96%b9%20%e7%ac%ac2%e7%89%88%e3%80%8f%e8%aa%ad%e3%82%93%e3%81%a0 - グリのクソブログ" target="_blank"
                title="Twitter" rel="nofollow"><i class="fab fa-twitter"></i></a>
        </li>
        
        <li>
            <a class="sns-share-btn sns-share-btn-hb"
                href="https://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fguricerin.github.io%2fshit-blog%2fpost%2f2021%2f12%2f05-wasbook%2f&title=%e3%80%8e%e4%bd%93%e7%b3%bb%e7%9a%84%e3%81%ab%e5%ad%a6%e3%81%b6%20%e5%ae%89%e5%85%a8%e3%81%aaWeb%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e4%bd%9c%e3%82%8a%e6%96%b9%20%e7%ac%ac2%e7%89%88%e3%80%8f%e8%aa%ad%e3%82%93%e3%81%a0 - グリのクソブログ" target="_blank"
                title="hatena" rel="nofollow">B!</a>
        </li>
        <li>
            <a class="sns-share-btn sns-share-btn-po"
                href="https://getpocket.com/edit?url=https%3a%2f%2fguricerin.github.io%2fshit-blog%2fpost%2f2021%2f12%2f05-wasbook%2f&title=%e3%80%8e%e4%bd%93%e7%b3%bb%e7%9a%84%e3%81%ab%e5%ad%a6%e3%81%b6%20%e5%ae%89%e5%85%a8%e3%81%aaWeb%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e4%bd%9c%e3%82%8a%e6%96%b9%20%e7%ac%ac2%e7%89%88%e3%80%8f%e8%aa%ad%e3%82%93%e3%81%a0 - グリのクソブログ" target="_blank" title="pocket"
                rel="nofollow"><i class="fab fa-get-pocket"></i></a>
        </li>
    </ul>
</div>




<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="https://guricerin.github.io/shit-blog/post/2021/11/23-infra-engineer-text2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">『インフラエンジニアの教科書2』読んだ</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="https://guricerin.github.io/shit-blog/post/2021/12/08-operation-linux-server/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">『ゼロからはじめるLinuxサーバー構築・運用ガイド』読んだ</p>
		</a>
	</div>
</nav>


<script src="https://utteranc.es/client.js" repo="guricerin/shit-blog" issue-term="pathname" label="[By Utterances]"
    theme="github-light" crossorigin="anonymous" async>
    </script>


      </div>
      

    </div>
    <footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 guricerin.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
  </div>
  <script async defer src="https://guricerin.github.io/shit-blog/%20js/menu.js"></script>
  <script src="https://guricerin.github.io/shit-blog/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>

</html>
